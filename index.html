<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>TikTalk - Stranger Chat</title>
  <style>
    :root {
      --safe-area-inset-top: env(safe-area-inset-top, 0px);
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      --emoji-picker-height: 350px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; user-select: none; -webkit-user-select: none; }
    body { background: #fff; display: flex; flex-direction: column; height: 100vh; transition: background 0.3s, color 0.3s; color: #0f172a; overflow: hidden; position: fixed; inset: 0; overscroll-behavior-y: none; }
    body.dark-mode { background: #0b0f15; color: #e5e7eb; }

    #video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; display: none; flex-direction: column; }
    #video-container.visible { display: flex; }
    .video-wrapper { width: 100%; height: 50%; position: relative; overflow: hidden; background: transparent; }
    .video-wrapper video { position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%; width: auto; height: auto; object-fit: cover; transform: translate(-50%, -50%) scaleX(-1); }
    .chat-wrapper { position: relative; flex: 1; overflow: hidden; z-index: 2; }
    body.video-mode-active .chat-wrapper { background: transparent; }
    body.video-mode-active header, body.video-mode-active footer, body.video-mode-active .footerNote, body.video-mode-active #nextBtn { z-index: 10005; }
    body.video-mode-active .msg { box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    body.video-mode-active .me { background-color: rgba(42, 61, 102, 0.9); color: #e5e7eb; }
    body.video-mode-active .stranger { background-color: rgba(45, 55, 72, 0.9); color: #e5e7eb; }
    body.video-mode-active.light-mode .me { background-color: rgba(230, 240, 255, 0.9); color: #0f172a; }
    body.video-mode-active.light-mode .stranger { background-color: rgba(240, 240, 245, 0.9); color: #0f172a; }
    
    header { position: fixed !important; top: var(--safe-area-inset-top); left: 0; right: 0; display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: #fff; z-index: 10003; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 0 0 16px 16px; }
    body.dark-mode header { background: #10161d; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    header .left, header .right { display: flex; align-items: center; gap: 8px; }
    header svg.logo { height: 60px; width: auto; }
    .eye { animation: blink 4s infinite; }
    @keyframes blink { 0%, 95% { opacity: 1; } 97%, 99% { opacity: 0.1; } 100% { opacity: 1; } }
    
    #chat { position: absolute; inset: 0; overflow-y: auto; overscroll-behavior: contain; padding: calc(70px + var(--safe-area-inset-top)) 15px calc(70px + var(--safe-area-inset-bottom)); -webkit-overflow-scrolling: touch; }
    #messages { display: flex; flex-direction: column; gap: 8px; }
    .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; word-wrap: break-word; font-size: 15px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.06); display: inline-block; }
    .me { align-self: flex-end; background: #e6f0ff; color: #0f172a; border-bottom-right-radius: 6px; }
    body.dark-mode .me { background: #2a3d66; color: #e5e7eb; }
    .stranger { align-self: flex-start; background: #f0f0f5; color: #0f172a; border-bottom-left-radius: 6px; }
    body.dark-mode .stranger { background: #2d3748; color: #e5e7eb; }
    .popup { background: transparent; border: none; padding: 8px; text-align: center; color: #555; max-width: 250px; margin: 8px auto; font-size: 14px; }
    body.dark-mode .popup { color: #e5e7eb; }
    #typingIndicator { font-size: 13px; color: #888; margin: 15px 0 10px; text-align: left; display: none; }
    body.dark-mode #typingIndicator { color: #b0b0b0; }
    .typing-container { display: flex; align-items: center; gap: 6px; }
    .typing-dot { width: 8px; height: 8px; border-radius: 50%; background: linear-gradient(45deg, #007bff, #00eaff); animation: typingBounce 1.2s ease-in-out infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
    footer { position: fixed !important; bottom: calc(10px + var(--safe-area-inset-bottom)); left: 8px; right: 8px; display: flex; align-items: center; padding: 6px; gap: 8px; background: #fff; z-index: 10000; height: 56px; border-radius: 35px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); transition: bottom 0.3s ease-out; }
    body.dark-mode footer { background: #10161d; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); }
    .footerNote { position: fixed; bottom: calc(72px + var(--safe-area-inset-bottom)); left: 0; right: 0; text-align: center; font-size: 14px; color: #555; z-index: 9999; transition: bottom 0.3s ease-out; }
    body.dark-mode .footerNote { color: #e5e7eb; }
    .inputWrapper { flex: 1; position: relative; display: flex; align-items: center; height: 40px; }
    textarea { width: 100%; resize: none; padding: 10px 18px; border: 1px solid #ccc !important; border-radius: 20px; font-size: 14px; outline: none; height: 40px; background: transparent !important; color: #0f172a; }
    body.dark-mode textarea { border: 1px solid #4a5568 !important; color: #e5e7eb; }
    #emojiToggle { border: none; font-size: 20px; cursor: pointer; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: transparent !important; box-shadow: none !important; color: #0f172a; flex-shrink: 0; }
    body.dark-mode #emojiToggle { color: #e5e7eb; }
    button { padding: 0 14px; border: none; border-radius: 20px; background: #007bff; color: #fff; font-weight: bold; cursor: pointer; font-size: 14px; }
    #sendBtn { width: 46px; height: 46px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 8px; box-shadow: 0 2px 8px rgba(0,123,255,0.4); }
    #sendBtn svg { width: 24px; height: 24px; }
    #nextBtn { position: fixed; bottom: calc(80px + var(--safe-area-inset-bottom)); right: 20px; width: 40px; height: 40px; border-radius: 50%; padding: 0; background: #ff3b30; display: none; align-items: center; justify-content: center; z-index: 10002; box-shadow: 0 2px 8px rgba(255,59,48,0.4); transition: bottom 0.3s ease-out; }
    
    #emojiPicker {
      position: fixed;
      left: 0;
      width: 100%;
      height: var(--emoji-picker-height);
      bottom: 0;
      z-index: 10001;
      opacity: 0;
      transform: translateY(100%);
      transition: transform 0.3s ease-out, opacity 0.3s ease-out;
      pointer-events: none;
      background: #f9f9f9;
    }
    body.dark-mode #emojiPicker { background: #181f2a; }
    #emojiPicker.show { opacity: 1; transform: translateY(0); pointer-events: auto; }

    .icon-btn { width: 28px; height: 28px; font-size: 20px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; background: transparent !important; border: none; box-shadow: none !important; color: #0f172a; padding: 0; }
    body.dark-mode .icon-btn { color: #e5e7eb; }
    .share-btn-wrapper { position: relative; }
    .share-btn { padding: 0; background: transparent; border: none; border-radius: 50%; width: 24px; height: 24px; position: relative; display: flex !important; align-items: center; justify-content: center; z-index: 10005; }
    .share-animation { position: absolute; inset: -2px; border-radius: 50%; z-index: 10006; pointer-events: none; }
    .share-animation::before { content: ''; position: absolute; inset: 0; border-radius: 50%; padding: 2px; background: linear-gradient(45deg, #00eaff, #007bff, #6a00ff, #00eaff); background-size: 300%; -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: shareBorderAnimation 3s ease infinite; }
    @keyframes shareBorderAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    
    .share-sheet {
      position: fixed;
      background: transparent;
      border-radius: 12px;
      padding: 12px;
      box-shadow: none;
      display: none;
      flex-direction: column;
      gap: 8px;
      z-index: 10007;
      opacity: 0;
      transform: translateX(-50%) translateY(-20px); /* Changed */
      transition: all 0.2s ease;
    }
    body.dark-mode .share-sheet {
      background: transparent;
      box-shadow: none;
    }
    .share-sheet.show {
      transform: translateX(-50%) translateY(0); /* Changed */
      opacity: 1;
      display: flex;
    }
    .share-sheet button {
      background: #f8f9fa !important;
      border: 1px solid #dee2e6 !important;
      border-radius: 50%;
      padding: 6px; /* Changed */
      width: 40px; /* Changed */
      height: 40px; /* Changed */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .share-sheet button:hover { background: #e9ecef !important; transform: scale(1.05); }
    body.dark-mode .share-sheet button { background: #2d3748 !important; border-color: #4a5568 !important; }
    body.dark-mode .share-sheet button:hover { background: #4a5568 !important; }
    .share-sheet button img, .share-sheet button svg {
      width: 20px; /* Changed */
      height: 20px; /* Changed */
    }
    .share-sheet .link {
      border-radius: 50%;
      width: 40px; /* Changed */
      height: 40px; /* Changed */
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa !important;
      border: 1px solid #dee2e6 !important;
      color: #007bff !important;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .share-sheet .link:hover { background: #e9ecef !important; transform: scale(1.05); }
    
    .start-chatting-btn { position: fixed; bottom: calc(130px + var(--safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); padding: 12px 24px; background: #007bff; color: #fff; border: none; border-radius: 25px; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10001; animation: pulse-glow 2s infinite; display: block; }
    body.dark-mode .start-chatting-btn { box-shadow: 0 4px 15px rgba(0,123,255,0.4); }
    @keyframes pulse-glow { 0% { box-shadow: 0 4px 15px rgba(0,123,255,0.4); } 50% { box-shadow: 0 4px 20px rgba(0,123,255,0.7); transform: translateX(-50%) scale(1.05); } 100% { box-shadow: 0 4px 15px rgba(0,123,255,0.4); } }
    .mode-btn-animate { animation: spin 0.4s ease-in-out; }
    @keyframes spin { from { transform: rotate(0deg) scale(1); } to { transform: rotate(360deg) scale(0.9); } }

    .searching-container { display: flex; justify-content: center; align-items: center; padding: 15px 0; }
    .pulse-dots { display: flex; align-items: center; justify-content: center; gap: 4px; }
    .pulse-dot { width: 10px; height: 10px; border-radius: 50%; background: linear-gradient(45deg,#00eaff,#6a00ff); animation: pulse 1.5s ease-in-out infinite; }
    .pulse-dot:nth-child(1) { animation-delay: 0s; } .pulse-dot:nth-child(2) { animation-delay: 0.2s; } .pulse-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { 0%,100% { transform: scale(0.8); opacity: 0.7; } 50% { transform: scale(1.2); opacity: 1; } }
    .searching-text { margin-left: 10px; font-weight: 500; color: #555; }
    body.dark-mode .searching-text { color: #e5e7eb; }

  </style>
</head>
<body>
  
  <div id="video-container">
    <div class="video-wrapper" id="remote-video-wrapper"><video id="remoteVideo" playsinline autoplay></video></div>
    <div class="video-wrapper" id="local-video-wrapper"><video id="localVideo" playsinline autoplay muted></video></div>
  </div>

  <header>
    <div class="left"><svg class="logo" width="auto" height="60" viewBox="0 0 420 140" xmlns="http://www.w3.org/2000/svg"><defs> <linearGradient id="gBubble" x1="0%" y1="0%" x2="100%" y2="100%"> <stop offset="0%" stop-color="#00eaff"> <animate attributeName="stop-color" dur="6s" values="#00eaff;#007bff;#6a00ff;#00eaff" repeatCount="indefinite"/> </stop> <stop offset="100%" stop-color="#007bff"> <animate attributeName="stop-color" dur="6s" values="#007bff;#6a00ff;#00eaff;#007bff" repeatCount="indefinite"/> </stop> </linearGradient> </defs> <g transform="translate(60,70) scale(1.2)"> <circle cx="0" cy="0" r="45" fill="url(#gBubble)"/> <ellipse class="eye" cx="-12" cy="-9" rx="4.5" ry="7" fill="#fff"/> <path d="M 8 -9 Q 12 -13 16 -9" stroke="#fff" stroke-width="2.5" stroke-linecap="round" fill="none"/> <path d="M -10 10 Q 0 18 10 10" stroke="#fff" stroke-width="2" stroke-linecap="round" fill="none"/> </g> <text x="120" y="70" font-size="56" font-family="Segoe UI, Arial, sans-serif" font-weight="800" fill="#007bff" dominant-baseline="middle">TikTalk</text></svg></div>
    <div class="right">
      <button id="modeToggleBtn" class="icon-btn" title="Switch to Video Chat"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg></button>
      <button id="themeToggle" class="icon-btn">🌙</button>
      <div class="share-btn-wrapper">
        <button id="shareBtn" class="share-btn"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" style="position: absolute; inset: 0; margin: auto; width: 12px;"><path d="M18 8l-8 8-8-8"/><animate attributeName="stroke" values="#007bff;#00eaff;#6a00ff;#007bff" dur="3s" repeatCount="indefinite"/></svg></button>
        <div class="share-animation"></div>
        <div class="share-sheet" id="shareSheet"></div>
      </div>
    </div>
  </header>

  <div class="chat-wrapper"><main id="chat"><div id="messages"></div><div id="typingIndicator" style="display:none;"><div class="typing-container"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div></main></div>
  <button id="startChattingBtn" class="start-chatting-btn">Start Chat</button>
  <p class="footerNote">Made in India <span class="heart">♥️</span></p>
  <footer>
    <button id="emojiToggle" aria-label="Toggle emoji picker" aria-expanded="false">😊</button>
    <div class="inputWrapper"><textarea id="messageInput" placeholder="Type a message..."></textarea></div>
    <button id="sendBtn" title="Send"><svg viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
  </footer>
  <button id="nextBtn" title="Next"><svg viewBox="0 0 24 24" fill="white"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button>
  <div id="emojiPicker" aria-hidden="true"></div>
  <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
        const { body } = document, header = document.querySelector('header'), messagesDiv = document.getElementById("messages"), input = document.getElementById("messageInput"), sendBtn = document.getElementById("sendBtn"), nextBtn = document.getElementById("nextBtn"), startChattingBtn = document.getElementById("startChattingBtn"), typingIndicator = document.getElementById("typingIndicator"), themeToggle = document.getElementById("themeToggle"), shareBtnWrapper = document.querySelector(".share-btn-wrapper"), shareBtn = document.getElementById("shareBtn"), shareSheet = document.getElementById("shareSheet"), emojiToggle = document.getElementById("emojiToggle"), emojiPicker = document.getElementById("emojiPicker"), modeToggleBtn = document.getElementById("modeToggleBtn"), videoContainer = document.getElementById('video-container'), localVideo = document.getElementById('localVideo'), remoteVideo = document.getElementById('remoteVideo'), footer = document.querySelector('footer'), footerNote = document.querySelector('.footerNote');
        let ws, isConnected = false, typingTimeout, currentMode = 'text', peerConnection, localStream, lastKeyboardHeight = parseInt(localStorage.getItem('lastKeyboardHeight')) || 350;
        const stunServers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        
        function debounce(func, wait) { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
        const debouncedAdjustLayout = debounce(() => { if (window.visualViewport) { const keyboardHeight = window.innerHeight - window.visualViewport.height; if (keyboardHeight > 100) { lastKeyboardHeight = keyboardHeight; localStorage.setItem('lastKeyboardHeight', lastKeyboardHeight); } adjustLayout(keyboardHeight); } }, 50);
        function adjustLayout(keyboardHeight = 0) { if (body.classList.contains('video-mode-active')) return; const safeBottom = parseInt(getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-bottom)'), 10) || 0; const isEmojiOpen = emojiPicker.classList.contains('show'); const height = isEmojiOpen ? lastKeyboardHeight : keyboardHeight; if (height > 50) { document.documentElement.style.setProperty('--emoji-picker-height', `${lastKeyboardHeight}px`); footer.style.bottom = `${height}px`; footerNote.style.bottom = `calc(${height + 62}px)`; nextBtn.style.bottom = `calc(${height + 80}px)`; } else { footer.style.bottom = `calc(10px + ${safeBottom}px)`; footerNote.style.bottom = `calc(72px + ${safeBottom}px)`; nextBtn.style.bottom = `calc(80px + ${safeBottom}px)`; } }
        function initializeEmojiPicker() { if (window.EmojiMart) { const picker = new EmojiMart.Picker({ onEmojiSelect: (e) => { input.value += e.native; input.focus(); }, theme: body.classList.contains("dark-mode") ? "dark" : "light", previewPosition: "none" }); emojiPicker.innerHTML = ''; emojiPicker.appendChild(picker); window._emojiPickerInstance = picker; } }
        function scrollToBottom() { const chatDiv = document.getElementById("chat"); chatDiv.scrollTop = chatDiv.scrollHeight; }
        
        const setUIMode = (mode) => { 
            currentMode = mode; 
            if (isConnected) { cleanUpConnection(); messagesDiv.innerHTML = ''; }
            
            modeToggleBtn.classList.add('mode-btn-animate'); 
            setTimeout(() => modeToggleBtn.classList.remove('mode-btn-animate'), 400); 
            if (mode === 'video') { 
                modeToggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`; 
                modeToggleBtn.title = "Switch to Text Chat"; 
                body.classList.add('video-mode-active'); 
                videoContainer.classList.add('visible');
                showTempPopup('Welcome to TikTalk Video Call');
                startChattingBtn.style.display = 'block';
            } else { 
                modeToggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>`; 
                modeToggleBtn.title = "Switch to Video Chat"; 
                body.classList.remove('video-mode-active'); 
                videoContainer.classList.remove('visible'); 
                showTempPopup('Welcome to TikTalk Chat');
                startChattingBtn.style.display = 'block';
            } 
        };
        const addMessage = (text, who) => { const div = document.createElement("div"); div.className = "msg " + who; div.textContent = text; messagesDiv.appendChild(div); scrollToBottom(); };
        const showPopup = (text, isSearching = false) => { 
            if (isSearching) {
                messagesDiv.innerHTML = `<div class="popup"><div class="searching-container"><div class="pulse-dots"><div class="pulse-dot"></div><div class="pulse-dot"></div><div class="pulse-dot"></div></div><div class="searching-text">${text}</div></div></div>`;
            } else {
                messagesDiv.innerHTML = `<div class="popup">${text}</div>`;
            }
            scrollToBottom(); 
        };
        let tempPopupTimeout;
        const showTempPopup = (text) => { 
            clearTimeout(tempPopupTimeout); 
            const existingTempPopup = document.querySelector('.temp-popup');
            if(existingTempPopup) existingTempPopup.remove();
            const tempDiv = document.createElement('div'); 
            tempDiv.className = 'popup temp-popup'; 
            tempDiv.style.position = 'fixed'; 
            tempDiv.style.top = '150px';
            tempDiv.style.left = '50%'; 
            tempDiv.style.transform = 'translateX(-50%)'; 
            tempDiv.style.background = 'rgba(0,0,0,0.7)'; 
            tempDiv.style.color = 'white'; 
            tempDiv.style.padding = '10px 20px'; 
            tempDiv.style.borderRadius = '20px'; 
            tempDiv.style.zIndex = '20000'; 
            tempDiv.textContent = text; 
            body.appendChild(tempDiv); 
            tempPopupTimeout = setTimeout(() => tempDiv.remove(), 3000); 
        };
        const updateInputState = (connected) => { isConnected = connected; input.disabled = !connected; sendBtn.disabled = !connected; };
        const startMedia = async () => { try { localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true }); localVideo.srcObject = localStream; return true; } catch (e) { showPopup("🚨 Camera/Mic access denied."); setUIMode('text'); return false; } };
        const stopMedia = () => { if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; localVideo.srcObject = null; } };
        const closePeerConnection = () => { if (peerConnection) { peerConnection.close(); peerConnection = null; } remoteVideo.srcObject = null; };
        const cleanUpConnection = () => { if (isConnected) showPopup('❌ Disconnected.'); updateInputState(false); if (ws) { ws.onclose = null; ws.close(); } closePeerConnection(); stopMedia(); };
        const createPeerConnection = () => { closePeerConnection(); peerConnection = new RTCPeerConnection(stunServers); peerConnection.onicecandidate = e => e.candidate && ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate })); peerConnection.ontrack = e => remoteVideo.srcObject = e.streams[0]; if (localStream) { localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream)); } };
        const connectStranger = async () => { cleanUpConnection(); messagesDiv.innerHTML = ''; showPopup(`Searching for a Stranger...`, true); if (currentMode === 'video') { if (!(await startMedia())) return; } ws = new WebSocket("wss://tiktalkchat-backend-v2.onrender.com"); ws.onopen = () => ws.send(JSON.stringify({ type: 'join', mode: currentMode })); ws.onmessage = async (event) => { const data = JSON.parse(event.data); switch (data.type) { case 'system': if (data.text === 'connected') { messagesDiv.innerHTML = ''; showPopup('✅ Connected!'); updateInputState(true); if (currentMode === 'video') { createPeerConnection(); const offer = await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer); ws.send(JSON.stringify({ type: 'offer', offer })); } } else if (data.text === 'disconnected') { showPopup('❌ Stranger disconnected.'); cleanUpConnection(); } else if (data.text === 'waiting') { showPopup(`Searching for a Stranger...`, true); } break; case 'message': addMessage(data.text, 'stranger'); break; case 'typing': typingIndicator.style.display = 'block'; clearTimeout(typingTimeout); typingTimeout = setTimeout(() => typingIndicator.style.display = 'none', 1500); break; case 'offer': createPeerConnection(); await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer)); const answer = await peerConnection.createAnswer(); await peerConnection.setLocalDescription(answer); ws.send(JSON.stringify({ type: 'answer', answer })); break; case 'answer': await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer)); break; case 'candidate': if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)); break; } }; ws.onclose = () => cleanUpConnection(); ws.onerror = () => { showPopup('🔌 Connection error.'); cleanUpConnection(); }; };
        
        modeToggleBtn.addEventListener('click', () => { if (isConnected) { if (confirm("This will end the current chat. Continue?")) { cleanUpConnection(); setUIMode(currentMode === 'text' ? 'video' : 'text'); } } else { setUIMode(currentMode === 'text' ? 'video' : 'text'); } });
        startChattingBtn.addEventListener('click', () => { startChattingBtn.style.display = 'none'; nextBtn.style.display = 'flex'; connectStranger(); });
        nextBtn.addEventListener('click', connectStranger);
        sendBtn.addEventListener('click', () => { if (isConnected && input.value.trim()) { ws.send(JSON.stringify({ type: 'message', text: input.value })); addMessage(input.value, 'me'); input.value = ''; } });
        input.addEventListener('keypress', (e) => (e.key === 'Enter') && (e.preventDefault(), sendBtn.click()));
        input.addEventListener('input', () => isConnected && ws?.readyState === WebSocket.OPEN && ws.send(JSON.stringify({ type: 'typing' })));
        themeToggle.addEventListener("click", () => { body.classList.toggle("dark-mode"); const isDarkMode = body.classList.contains("dark-mode"); themeToggle.textContent = isDarkMode ? "☀️" : "🌙"; localStorage.setItem("theme", isDarkMode ? "dark" : "light"); window._emojiPickerInstance?.setOptions({ theme: isDarkMode ? "dark" : "light" }); });
        
        function initializeShareSheet() { shareSheet.innerHTML = `<button onclick="shareApp('whatsapp')"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"></button><button onclick="shareApp('instagram')"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" alt="Instagram"></button><button onclick="shareApp('facebook')"><img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_%282019%29.png" alt="Facebook"></button><button onclick="shareApp('x')" aria-label="Share on X"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="20" height="20"><circle cx="50" cy="50" r="50" fill="#1DA1F2"/><path d="M30,30 L70,70 M70,30 L30,70" stroke="#fff" stroke-width="10" stroke-linecap="round"/></svg></button><button class="link" onclick="shareApp('link')">🔗</button>`; }
        window.shareApp = (platform) => { const url = window.location.href; if(platform === 'link') { navigator.clipboard.writeText(url).then(() => alert('Link Copied!')); } else { let shareURL = ''; if (platform === 'whatsapp') shareURL = `https://wa.me/?text=${encodeURIComponent(url)}`; else if (platform === 'instagram') shareURL = `https://www.instagram.com`; else if (platform === 'facebook') shareURL = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`; else if (platform === 'x') shareURL = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}`; if(shareURL) window.open(shareURL); } };
        
        const handleShareBtn = (e) => {
            e.stopPropagation();
            if (!shareSheet.classList.contains('show')) {
                const headerRect = header.getBoundingClientRect();
                const btnRect = shareBtn.getBoundingClientRect();

                // Position the sheet below the header and centered with the button
                shareSheet.style.top = `${headerRect.bottom - 10}px`; // Changed
                shareSheet.style.left = `${btnRect.left + (btnRect.width / 2)}px`;

                shareSheet.classList.add('show');
            } else {
                shareSheet.classList.remove('show');
            }
        };
        shareBtn.addEventListener("click", handleShareBtn);
        
        emojiToggle.addEventListener("click", (e) => { e.stopPropagation(); const isPickerOpen = emojiPicker.classList.toggle('show'); emojiToggle.textContent = isPickerOpen ? "⌨️" : "😊"; if(isPickerOpen) { input.blur(); } adjustLayout(); });
        
        document.addEventListener('click', (e) => { if (!shareBtnWrapper.contains(e.target) && shareSheet.classList.contains('show')) shareSheet.classList.remove('show'); if (!emojiPicker.contains(e.target) && !emojiToggle.contains(e.target)) { if(emojiPicker.classList.contains('show')) { emojiPicker.classList.remove('show'); emojiToggle.textContent = "😊"; adjustLayout(); } } });
        
        if (window.visualViewport) { window.visualViewport.addEventListener('resize', debouncedAdjustLayout); }
        
        if (localStorage.getItem("theme") === "dark") { body.classList.add("dark-mode"); themeToggle.textContent = "☀️"; } else { body.classList.remove("dark-mode"); themeToggle.textContent = "🌙"; }
        
        initializeEmojiPicker(); 
        initializeShareSheet();
        
        showPopup("Welcome to TikTalk! Click 'Start Chat' to connect with a stranger."); 
        startChattingBtn.style.display = 'block'; 
        nextBtn.style.display = 'none';
        updateInputState(false);
    });
      <script src="index.js"></script>
</body>
</html>