<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TikTalk - Stranger Chat</title>
  <style>
    * {margin:0; padding:0; box-sizing:border-box; font-family: Arial, sans-serif;}
    body {background:#fff; display:flex; flex-direction:column; height:100vh; transition: background 0.3s, color 0.3s;}

    header {
      position:fixed; top:0; left:0; right:0;
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 15px;
      background:#fff;
      border-bottom:1px solid #ddd;
      z-index:1000;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    header h1 {font-size:18px; color:#007bff;}
    .header-buttons {display:flex; gap:10px;}

    #chat {flex:1; overflow-y:auto; padding:70px 15px 70px;}
    #messages {display:flex; flex-direction:column; gap:8px;}

    /* üí¨ Chat bubbles */
    .message-wrapper {display:flex; width:100%;}
    .message-wrapper.me {justify-content:flex-end;}
    .message-wrapper.stranger {justify-content:flex-start;}
    .msg {
      max-width:75%;
      padding:10px 14px;
      border-radius:18px;
      word-wrap:break-word;
      font-size:15px;
    }
    .me .msg {background:#007bff; color:#fff; border-bottom-right-radius:4px;}
    .stranger .msg {background:#f1f1f1; color:#000; border-bottom-left-radius:4px;}

    .popup {
      background:#f9f9f9; border:1px solid #ddd; border-radius:10px;
      padding:8px; text-align:center; color:#555;
      max-width:220px; margin:15px auto;
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
      font-size:14px;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }

    #typingIndicator {font-size:13px; color:#888; margin-top:5px; text-align:left; font-style:italic;}

    footer {
      position:fixed; bottom:0; left:0; right:0;
      display:flex; padding:8px; border-top:1px solid #ddd; gap:6px;
      background:#fff;
      z-index:1000;
      transition: background 0.3s, border-color 0.3s;
    }
    textarea {
      flex:1; resize:none; padding:10px;
      border:1px solid #ccc; border-radius:20px; font-size:15px;
      outline:none; height:40px;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    button {
      padding:0 14px; border:none; border-radius:20px;
      background:#007bff; color:#fff; font-weight:bold; cursor:pointer;
      font-size:14px; white-space:nowrap;
    }
    button#nextBtn {background:#ff3b30;}
    button:active {opacity:0.8;}
    p.footerNote {text-align:center; padding:5px; font-size:13px; color:#666; margin-bottom:50px;}

    /* üåô Dark mode styles */
    body.dark-mode {background:#121212; color:#e5e5e5;}
    body.dark-mode header {background:#1f1f1f; border-color:#333;}
    body.dark-mode footer {background:#1f1f1f; border-color:#333;}
    body.dark-mode .popup {background:#2a2a2a; border-color:#444; color:#ccc;}
    body.dark-mode textarea {background:#1f1f1f; color:#eee; border-color:#444;}
    body.dark-mode .stranger .msg {background:#2a2a2a; color:#eee;}
    body.dark-mode p.footerNote {color:#aaa;}
  </style>
</head>
<body>
  <header>
    <h1>TikTalk</h1>
    <div class="header-buttons">
      <button id="shareBtn">üì§</button>
      <button id="themeToggle">üåô</button>
    </div>
  </header>

  <main id="chat">
    <div id="messages"></div>
    <div id="typingIndicator" style="display:none;">Stranger is typing...</div>
  </main>

  <footer>
    <textarea id="messageInput" placeholder="Type a message..."></textarea>
    <button id="sendBtn">Send</button>
    <button id="nextBtn">Next</button>
  </footer>

  <p class="footerNote">Made in India ‚ô•Ô∏è</p>

  <script>
    window.TIKTALK_BACKEND = "https://tiktalk-server-8dmz.onrender.com";

    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const nextBtn = document.getElementById("nextBtn");
    const typingIndicator = document.getElementById("typingIndicator");

    let ws, typingTimeout;

    function addMessage(text, who){
      const wrapper = document.createElement("div");
      wrapper.className = "message-wrapper " + who;

      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.textContent = text;

      wrapper.appendChild(bubble);
      messagesDiv.appendChild(wrapper);

      // ‚úÖ Auto-scroll
      const chat = document.getElementById("chat");
      chat.scrollTop = chat.scrollHeight;
    }

    function showPopup(text){
      messagesDiv.innerHTML = `<div class="popup">${text}</div>`;
    }

    function connectStranger(){
      showPopup("üîç Connecting to server...");
      typingIndicator.style.display = "none";

      ws = new WebSocket(window.TIKTALK_BACKEND.replace("http","ws") + "/ws");

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);

          if (data.type === "system") {
            if (data.text === "waiting") {
              showPopup("üîç Searching for a stranger...");
            } else if (data.text === "connected") {
              showPopup("‚úÖ Connected! Say Hi üëã");
            } else if (data.text === "disconnected") {
              showPopup("‚ùå Stranger disconnected");
            }
          }

          if (data.type === "message") {
            typingIndicator.style.display = "none";
            addMessage(data.text, "stranger");
          }

          if (data.type === "typing") {
            typingIndicator.style.display = "block";
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(()=> {
              typingIndicator.style.display = "none";
            }, 1500);
          }

        } catch {
          console.log("Invalid data:", event.data);
        }
      };

      ws.onclose = () => {
        showPopup("‚ùå Disconnected from server");
        typingIndicator.style.display = "none";
      };
    }

    sendBtn.addEventListener("click", ()=>{
      if(input.value.trim() && ws && ws.readyState === WebSocket.OPEN){
        ws.send(JSON.stringify({type:"message", text:input.value}));
        addMessage(input.value, "me");
        input.value="";
      }
    });

    input.addEventListener("input", ()=>{
      if(ws && ws.readyState === WebSocket.OPEN){
        ws.send(JSON.stringify({type:"typing"}));
      }
    });

    nextBtn.addEventListener("click", ()=>{
      if(ws){ ws.close(); }
      connectStranger();
    });

    // üåô Theme toggle
    const themeToggle = document.getElementById("themeToggle");
    if(localStorage.getItem("theme") === "dark"){
      document.body.classList.add("dark-mode");
      themeToggle.textContent = "‚òÄÔ∏è";
    }
    themeToggle.addEventListener("click", ()=>{
      document.body.classList.toggle("dark-mode");
      if(document.body.classList.contains("dark-mode")){
        localStorage.setItem("theme","dark");
        themeToggle.textContent = "‚òÄÔ∏è";
      } else {
        localStorage.setItem("theme","light");
        themeToggle.textContent = "üåô";
      }
    });

    // üì§ Share button
    const shareBtn = document.getElementById("shareBtn");
    shareBtn.addEventListener("click", async ()=>{
      try {
        await navigator.share({
          title: "TikTalk - Stranger Chat",
          text: "Join me on TikTalk stranger chat!",
          url: window.location.href
        });
      } catch (err) {
        alert("Sharing failed or cancelled.");
      }
    });

    connectStranger();
  </script>
</body>
</html>