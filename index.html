<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>TikTalk - Stranger Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-mart@latest/css/emoji-mart.css" />
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        body {
            background: #fff;
            display: flex;
            flex-direction: column;
            height: 100vh;
            transition: background 0.3s, color 0.3s;
            color: #0f172a;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overscroll-behavior-y: none;
        }
        body.dark-mode {
            background: #0b0f15;
            color: #e5e7eb;
        }
        header {
            position: fixed !important;
            top: env(safe-area-inset-top);
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: #fff;
            z-index: 10003;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 0 0 16px 16px;
        }
        body.dark-mode header {
            background: #10161d;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        header .left, header .right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        header svg.logo {
            height: 60px;
            width: auto;
            display: block;
        }
        .chat-wrapper {
            position: relative;
            flex: 1;
            overflow: hidden;
        }
        #chat {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            overscroll-behavior: contain;
            contain: strict;
            padding: calc(70px + env(safe-area-inset-top)) 15px calc(70px + env(safe-area-inset-bottom));
            -webkit-overflow-scrolling: touch;
        }
        #messages {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .msg {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 18px;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            display: inline-block;
        }
        .me {
            align-self: flex-end;
            background: #e6f0ff;
            color: #0f172a;
            border-bottom-right-radius: 6px;
        }
        body.dark-mode .me {
            background: #2a3d66;
        }
        .stranger {
            align-self: flex-start;
            background: #f0f0f5;
            color: #0f172a;
            border-bottom-left-radius: 6px;
        }
        body.dark-mode .stranger {
            background: #2d3748;
        }
        .popup {
            background: transparent;
            border: none;
            padding: 8px;
            text-align: center;
            color: #555;
            max-width: 220px;
            margin: 8px auto;
            font-size: 14px;
        }
        body.dark-mode .popup {
            background: transparent;
            color: #e5e7eb;
        }
        #typingIndicator {
            font-size: 13px;
            color: #888;
            margin-top: 5px;
            text-align: left;
            display: none;
        }
        body.dark-mode #typingIndicator {
            color: #b0b0b0;
        }
        .typing-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 6px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(45deg, #007bff, #00eaff);
            animation: typingBounce 1.2s ease-in-out infinite;
            will-change: transform, opacity;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        footer {
            position: fixed !important;
            bottom: calc(10px + env(safe-area-inset-bottom));
            left: 8px;
            right: 8px;
            display: flex;
            align-items: center;
            padding: 6px;
            gap: 8px;
            background: #fff;
            z-index: 10000;
            height: 56px;
            min-height: 56px;
            max-height: 56px;
            overflow: hidden !important;
            -webkit-overflow-scrolling: none;
            contain: strict;
            box-sizing: border-box;
            -webkit-appearance: none;
            border-radius: 35px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: bottom 0.3s ease;
        }
        body.dark-mode footer {
            background: #10161d;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        .footerNote {
            position: fixed;
            bottom: calc(72px + env(safe-area-inset-bottom));
            left: 0;
            right: 0;
            text-align: center;
            font-size: 14px;
            color: #555;
            z-index: 9999;
        }
        body.dark-mode .footerNote {
            color: #e5e7eb;
        }
        .inputWrapper {
            flex: 1;
            flex-grow: 5;
            flex-basis: 0;
            position: relative;
            display: flex;
            align-items: center;
            height: 40px;
            min-height: 40px;
            max-height: 40px;
            overflow: hidden !important;
            box-sizing: border-box;
            background: transparent !important;
        }
        textarea {
            width: 100%;
            resize: none;
            padding: 10px 18px 10px 12px;
            border: 1px solid #ccc !important;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            height: 40px;
            min-height: 40px;
            max-height: 120px;
            line-height: 18px;
            background: transparent !important;
            color: #0f172a;
            overflow-y: auto !important;
            box-sizing: border-box;
            -webkit-appearance: none;
            z-index: 10002;
            touch-action: manipulation;
        }
        body.dark-mode textarea {
            border: 1px solid #4a5568 !important;
            background: transparent !important;
            color: #e5e7eb;
        }
        #emojiToggle {
            border: none;
            font-size: 20px;
            cursor: pointer;
            line-height: 1;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent !important;
            z-index: 10000;
            overflow: hidden;
            pointer-events: auto;
            touch-action: manipulation;
            margin-right: 8px;
            color: #0f172a;
            background: transparent !important;
            box-shadow: none !important;
        }
        body.dark-mode #emojiToggle {
            color: #e5e7eb;
            background: transparent !important;
            box-shadow: none !important;
        }
        #emojiToggle:hover, #emojiToggle:active, #emojiToggle:focus {
            background: transparent !important;
            box-shadow: none !important;
        }
        button {
            padding: 0 14px;
            border: none;
            border-radius: 20px;
            background: #007bff;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            -webkit-tap-highlight-color: transparent !important;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            touch-action: manipulation;
            pointer-events: auto;
        }
        button:active {
            opacity: 0.85;
        }
        #sendBtn {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            padding: 0;
            background: #007bff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            overflow: hidden;
            margin-left: 8px;
            box-shadow: 0 2px 8px rgba(0,123,255,0.4);
        }
        #sendBtn svg {
            width: 22px;
            height: 22px;
        }
        #nextBtn {
            position: fixed;
            bottom: calc(100px + env(safe-area-inset-bottom));
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            padding: 0;
            background: #ff3b30;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(255,59,48,0.4);
            pointer-events: auto;
        }
        #nextBtn svg {
            width: 24px;
            height: 24px;
        }
        #emojiPicker {
            position: fixed;
            left: 8px;
            right: 8px;
            margin: 0 auto;
            width: calc(100% - 16px);
            max-width: 400px;
            height: var(--emoji-picker-height, 350px);
            max-height: 50vh;
            overflow-y: auto;
            background: transparent !important;
            border-radius: 16px;
            z-index: 10001;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            will-change: transform, opacity, bottom;
            display: none;
            transform: translateY(30px) scale(0.98);
            bottom: calc(10px + env(safe-area-inset-bottom));
        }
        #emojiPicker.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            display: block;
            bottom: calc(10px + env(safe-area-inset-bottom));
        }
        body.dark-mode #emojiPicker {
            background: transparent !important;
        }
        .emoji-mart {
            width: 100% !important;
            height: 100% !important;
            overflow-y: auto !important;
            font-family: "Twemoji Mozilla", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", "EmojiOne Color", "Android Emoji", sans-serif !important;
            box-sizing: border-box !important;
            border-radius: 16px;
            background: transparent !important;
        }
        .emoji-mart-scroll {
            overflow-y: auto !important;
            height: auto !important;
        }
        @media (min-width: 768px) {
            #emojiPicker {
                width: 360px;
                left: auto;
                right: 8px;
                height: var(--emoji-picker-height, 350px);
                max-height: 350px;
                transform: translate(0, 30px) scale(0.98);
                bottom: calc(10px + env(safe-area-inset-bottom));
            }
            #emojiPicker.show {
                transform: translate(0, 0) scale(1);
                display: block;
                bottom: calc(10px + env(safe-area-inset-bottom));
            }
            .share-btn {
                width: 24px;
                height: 24px;
            }
            .share-btn svg.button-icon {
                width: 12px;
                height: 12px;
            }
            .right {
                gap: 8px;
                padding-right: 10px;
            }
            textarea {
                padding: 10px 18px 10px 12px;
            }
            #sendBtn {
                width: 46px;
                height: 46px;
            }
            #sendBtn svg {
                width: 22px;
                height: 22px;
            }
            #nextBtn {
                width: 50px;
                height: 50px;
                right: 20px;
                bottom: calc(100px + env(safe-area-inset-bottom));
            }
            #nextBtn svg {
                width: 24px;
                height: 24px;
            }
            .inputWrapper {
                flex-grow: 3;
            }
        }
        @media (max-width: 767px) {
            #emojiPicker {
                height: var(--emoji-picker-height, 350px) !important;
                max-height: 50vh !important;
                bottom: calc(10px + env(safe-area-inset-bottom));
            }
            #emojiPicker.show {
                transform: translate(0, 0) scale(1);
                display: block;
                bottom: calc(10px + env(safe-area-inset-bottom));
            }
            .share-btn {
                padding: 0;
                background: transparent;
                border: none;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                position: relative;
                color: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                z-index: 10005;
                visibility: visible;
                opacity: 1;
                overflow: hidden;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            }
            .share-btn svg.button-icon {
                width: 12px;
                height: 12px;
            }
            .right {
                gap: 6px;
                padding-right: 8px;
            }
            header {
                padding: 6px 8px;
            }
            textarea {
                padding: 10px 18px 10px 12px;
            }
            #sendBtn {
                width: 46px;
                height: 46px;
            }
            #sendBtn svg {
                width: 22px;
                height: 22px;
            }
            #nextBtn {
                width: 46px;
                height: 46px;
                right: 15px;
                bottom: calc(100px + env(safe-area-inset-bottom));
            }
            #nextBtn svg {
                width: 22px;
                height: 22px;
            }
        }
        @media (max-width: 480px) {
            .msg {
                max-width: 85%;
                font-size: 14px;
                padding: 8px 12px;
            }
            footer {
                padding: 6px;
                height: 56px;
                min-height: 56px;
                max-height: 56px;
                left: 8px;
                right: 8px;
                border-radius: 32px;
            }
            .inputWrapper {
                height: 40px;
                min-height: 40px;
                max-height: 40px;
            }
            textarea {
                height: 40px;
                min-height: 40px;
                max-height: 120px;
                font-size: 14px;
                padding: 10px 18px 10px 12px;
            }
            #emojiToggle {
                font-size: 18px;
                width: 44px;
                height: 44px;
            }
            #nextBtn {
                width: 44px;
                height: 44px;
                right: 12px;
                bottom: calc(100px + env(safe-area-inset-bottom));
            }
            #nextBtn svg {
                width: 20px;
                height: 20px;
            }
        }
        .icon-btn {
            width: 28px;
            height: 28px;
            font-size: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            touch-action: manipulation;
            background: transparent !important;
            border: none;
            box-shadow: none !important;
            pointer-events: auto;
        }
        .icon-btn:active {
            transform: scale(0.95);
        }
        .share-btn {
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            position: relative;
            color: #fff;
            display: flex !important;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10005;
            visibility: visible;
            opacity: 1;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            pointer-events: auto;
        }
        .share-btn svg.button-icon {
            width: 12px;
            height: 12px;
        }
        .share-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        body.dark-mode .share-btn {
            border-color: rgba(255,255,255,0.5);
        }
        body.dark-mode .share-btn:hover {
            border-color: rgba(255,255,255,0.7);
            box-shadow: 0 4px 12px rgba(255,255,255,0.2);
        }
        .right {
            position: relative;
            display: flex !important;
            align-items: center;
            gap: 8px;
            z-index: 10004;
            padding-right: 10px;
        }
        .share-animation {
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10006;
            pointer-events: none;
        }
        .share-animation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            padding: 2px;
            background: linear-gradient(45deg, #00eaff, #007bff, #6a00ff, #00eaff);
            background-size: 300% 300%;
            -webkit-mask:
                linear-gradient(#fff 0 0) content-box,
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: shareBorderAnimation 3s ease infinite;
        }
        @keyframes shareBorderAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .share-sheet {
            position: absolute;
            top: calc(100% + env(safe-area-inset-top));
            right: 0;
            background: #fff !important;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: row;
            gap: 12px;
            z-index: 10006;
            margin-top: 5px;
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        body.dark-mode .share-sheet {
            background: #1f2937 !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .share-sheet.show {
            transform: translateY(0);
            opacity: 1;
        }
        .share-sheet button {
            background: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 50%;
            padding: 8px;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10001;
            pointer-events: auto;
        }
        .share-sheet button:hover {
            background: #e9ecef !important;
            transform: scale(1.05);
        }
        body.dark-mode .share-sheet button {
            background: #2d3748 !important;
            border-color: #4a5568 !important;
        }
        body.dark-mode .share-sheet button:hover {
            background: #4a5568 !important;
        }
        .share-sheet button img {
            width: 24px;
            height: 24px;
        }
        .share-sheet button svg {
            display: block;
        }
        .share-sheet .link {
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
            color: #007bff !important;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .share-sheet .link:hover {
            background: #e9ecef !important;
            transform: scale(1.05);
        }
        button:focus, button:active,
        .icon-btn:focus, .icon-btn:active,
        .share-btn:focus, .share-btn:active,
        .share-sheet button:focus, .share-sheet button:active,
        button:focus-visible, .icon-btn:focus-visible,
        .share-btn:focus-visible, .share-sheet button:focus-visible {
            outline: none !important;
            box-shadow: none !important;
        }
        #copyLinkPopup {
            position: absolute;
            top: calc(100% + 15px);
            right: 0;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            font-size: 14px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10007;
            pointer-events: none;
            color: #fff;
            background: #007bff;
            transform: translateY(-10px);
        }
        #copyLinkPopup.show {
            opacity: 1;
            transform: translateY(0);
        }
        body.dark-mode #copyLinkPopup {
            background: #1d4ed8;
            color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .bubble, .typing-dot, .pulse-dot {
            will-change: transform, opacity;
        }
        .eye {
            transform-origin: center;
            animation: blink 4s infinite;
        }
        @keyframes blink {
            0%, 95% { opacity: 1; }
            96%, 98% { opacity: 0.1; }
            99%, 100% { opacity: 1; }
        }
        .smile {
            transform-origin: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .searching-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px 0;
        }
        .pulse-dots {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .pulse-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(45deg,#00eaff,#6a00ff);
            animation: pulse 1.5s ease-in-out infinite;
            will-change: transform, opacity;
        }
        .pulse-dot:nth-child(1) { animation-delay: 0s; }
        .pulse-dot:nth-child(2) { animation-delay: 0.2s; }
        .pulse-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse {
            0%, 100% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        .searching-text {
            margin-left: 10px;
            font-weight: 500;
            color: #555;
            white-space: nowrap;
        }
        body.dark-mode .searching-text {
            color: #e5e7eb;
        }
        .connected-checkmark {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        .connected-checkmark::after {
            content: "";
            display: block;
            width: 8px;
            height: 14px;
            border: solid #00c853;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
            animation: checkmark-appear 0.5s ease-in-out;
        }
        @keyframes checkmark-appear {
            0% { opacity: 0; transform: rotate(45deg) scale(0); }
            50% { transform: rotate(45deg) scale(1.2); }
            100% { opacity: 1; transform: rotate(45deg) scale(1); }
        }
        .start-chatting-btn {
            position: fixed;
            bottom: calc(130px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10001;
            animation: pulse-glow 2s infinite;
            display: block;
            pointer-events: auto;
        }
        body.dark-mode .start-chatting-btn {
            background: #007bff;
            box-shadow: 0 4px 15px rgba(0,123,255,0.4);
        }
        @keyframes pulse-glow {
            0% { box-shadow: 0 4px 15px rgba(0,123,255,0.4); transform: translateX(-50%) scale(1); }
            50% { box-shadow: 0 4px 20px rgba(0,123,255,0.7); transform: translateX(-50%) scale(1.05); }
            100% { box-shadow: 0 4px 15px rgba(0,123,255,0.4); transform: translateX(-50%) scale(1); }
        }
        .start-chatting-btn:hover {
            animation: none;
            box-shadow: 0 4px 20px rgba(0,123,255,0.8);
            transform: translateX(-50%) scale(1);
        }
        .button-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auto-scroll-enabled #messages {
            scroll-behavior: smooth;
        }
        footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .inputWrapper {
            border: none !important;
            box-shadow: none !important;
        }
        textarea::-webkit-scrollbar {
            width: 4px;
        }
        textarea::-webkit-scrollbar-track {
            background: transparent;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 2px;
        }
        body.dark-mode textarea::-webkit-scrollbar-thumb {
            background: #555;
        }
    </style>
</head>
<body>
    <header>
        <div class="left">
            <svg class="logo" width="auto" height="60" viewBox="0 0 420 140" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="TikTalk animated logo">
                <defs>
                    <linearGradient id="gBubble" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#00eaff">
                            <animate attributeName="stop-color" dur="6s" values="#00eaff;#007bff;#6a00ff;#00eaff" repeatCount="indefinite"/>
                        </stop>
                        <stop offset="100%" stop-color="#007bff">
                            <animate attributeName="stop-color" dur="6s" values="#007bff;#6a00ff;#00eaff;#007bff" repeatCount="indefinite"/>
                        </stop>
                    </linearGradient>
                    <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur stdDeviation="6" result="b"/>
                        <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                </defs>
                <g transform="translate(60,70) scale(1.2)">
                    <circle cx="0" cy="0" r="45" fill="url(#gBubble)"/>
                    <ellipse class="eye left" cx="-12" cy="-9" rx="4.5" ry="7" fill="#fff"/>
                    <path class="right" d="M 8 -9 Q 12 -13 16 -9" stroke="#fff" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                    <path class="smile" d="M -10 10 Q 0 18 10 10" stroke="#fff" stroke-width="2" stroke-linecap="round" fill="none"/>
                </g>
                <text x="120" y="70" font-size="56" font-family="Segoe UI, Arial, sans-serif" font-weight="800" fill="#007bff" dominant-baseline="middle" alignment-baseline="middle">TikTalk</text>
            </svg>
        </div>
        <div class="right">
            <button id="themeToggle" class="icon-btn">üåô</button>
            <div style="position: relative;">
                <button id="shareBtn" class="share-btn">
                    <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                        <path d="M18 8l-8 8-8-8"/>
                        <animate attributeName="stroke" values="#007bff;#00eaff;#6a00ff;#007bff" dur="3s" repeatCount="indefinite"/>
                        <animate attributeName="transform" values="scale(1);scale(1.1);scale(1)" dur="1.5s" repeatCount="indefinite"/>
                    </svg>
                </button>
                <div class="share-animation"></div>
            </div>
            <div class="share-sheet" id="shareSheet">
                <button onclick="shareApp('whatsapp')"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"></button>
                <button onclick="shareApp('instagram')"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" alt="Instagram"></button>
                <button onclick="shareApp('facebook')"><img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_%282019%29.png" alt="Facebook"></button>
                <button onclick="shareApp('x')" aria-label="Share on X">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="20" height="20">
                        <circle cx="50" cy="50" r="50" fill="#1DA1F2"/>
                        <path d="M30,30 L70,70 M70,30 L30,70" stroke="#fff" stroke-width="10" stroke-linecap="round"/>
                    </svg>
                </button>
                <button class="link" onclick="shareApp('link')">üîó</button>
            </div>
        </div>
    </header>
    <div class="chat-wrapper">
        <main id="chat">
            <div id="messages"></div>
            <div id="typingIndicator" style="display:none;">
                <div class="typing-container">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </main>
    </div>
    <button id="startChattingBtn" class="start-chatting-btn">Start Chat</button>
    <p class="footerNote">Made in India <span class="heart">‚ô•Ô∏è</span></p>
    <footer>
        <button id="emojiToggle" aria-label="Toggle emoji picker" aria-expanded="false">üòä</button>
        <div class="inputWrapper">
            <textarea id="messageInput" placeholder="Type a message..."></textarea>
        </div>
        <div class="footer-buttons">
            <button id="sendBtn" title="Send">
                <svg class="button-icon" viewBox="0 0 24 24" fill="white">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </footer>
    <button id="nextBtn" title="Next">
        <svg class="button-icon" viewBox="0 0 24 24" fill="white">
            <path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/>
        </svg>
    </button>
    <div id="emojiPicker" aria-hidden="true"></div>
    <script>
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM loaded, initializing buttons...");
            const shareBtn = document.getElementById("shareBtn");
            if (shareBtn) {
                shareBtn.style.display = "flex";
                shareBtn.style.visibility = "visible";
                shareBtn.style.opacity = "1";
                console.log("Share button initialized");
            } else {
                console.error("Share Button not found!");
            }

            const savedTheme = localStorage.getItem("theme");
            if (savedTheme === "dark") {
                document.body.classList.add("dark-mode");
                themeToggle.textContent = "‚òÄÔ∏è";
                console.log("Dark mode applied from localStorage");
            }

            if ('virtualKeyboard' in navigator) {
                navigator.virtualKeyboard.overlaysContent = true;
                navigator.virtualKeyboard.addEventListener('geometrychange', debouncedAdjustLayout);
                console.log("Virtual keyboard support enabled");
            }

            function initializeEmojiPicker() {
                const emojiPicker = document.getElementById("emojiPicker");
                const input = document.getElementById("messageInput");
                if (!window._emojiPickerInstance) {
                    console.log("Loading EmojiMart...");
                    const script = document.createElement("script");
                    script.src = "https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js";
                    script.onload = () => {
                        if (window.EmojiMart) {
                            const picker = new EmojiMart.Picker({
                                onEmojiSelect: (e) => {
                                    if (!emojiPicker.classList.contains('show') || document.activeElement !== input) {
                                        return;
                                    }
                                    input.value += e.native;
                                    input.focus();
                                    debouncedAdjustLayout();
                                    console.log(`Emoji selected: ${e.native}`);
                                },
                                theme: document.body.classList.contains("dark-mode") ? "dark" : "light",
                                previewPosition: "none",
                                skinTonePosition: "search",
                                categories: ["frequent", "people", "nature", "foods", "activity", "places", "objects", "symbols", "flags"],
                                emoji: "üòä"
                            });
                            emojiPicker.appendChild(picker);
                            window._emojiPickerInstance = picker;
                            console.log("Emoji picker initialized");
                        }
                    };
                    script.onerror = () => console.error("Failed to load EmojiMart");
                    document.head.appendChild(script);
                }
            }

            initializeEmojiPicker();

            const emojiToggle = document.getElementById("emojiToggle");
            const emojiPicker = document.getElementById("emojiPicker");
            const input = document.getElementById("messageInput");
            const footer = document.querySelector("footer");
            let wasPickerOpenBeforeKeyboard = false;

            const handleEmojiToggle = (e) => {
                e.preventDefault();
                e.stopImmediatePropagation();
                console.log("Emoji toggle clicked");
                const isPickerOpen = emojiPicker.classList.contains('show');
                if (isPickerOpen) {
                    emojiPicker.classList.remove('show');
                    emojiPicker.style.display = 'none';
                    emojiToggle.textContent = "üòä";
                    emojiToggle.setAttribute('aria-expanded', 'false');
                    wasPickerOpenBeforeKeyboard = false;
                    input.focus();
                } else {
                    emojiPicker.classList.add('show');
                    emojiPicker.style.display = 'block';
                    emojiToggle.textContent = "‚å®Ô∏è";
                    emojiToggle.setAttribute('aria-expanded', 'true');
                    input.blur();
                }
                debouncedAdjustLayout();
            };

            emojiToggle.removeEventListener("click", handleEmojiToggle);
            emojiToggle.removeEventListener("touchstart", handleEmojiToggle);
            emojiToggle.addEventListener("click", handleEmojiToggle, { passive: false });
            emojiToggle.addEventListener("touchstart", handleEmojiToggle, { passive: false });

            const handleInputInteraction = (e) => {
                e.stopImmediatePropagation();
                console.log("Input interaction");
            };
            input.removeEventListener("click", handleInputInteraction);
            input.removeEventListener("touchstart", handleInputInteraction);
            input.addEventListener("click", handleInputInteraction, { passive: true });
            input.addEventListener("touchstart", handleInputInteraction, { passive: true });

            input.addEventListener("focus", () => {
                console.log("Input focused");
                if (emojiPicker.classList.contains('show')) {
                    emojiPicker.classList.remove('show');
                    emojiPicker.style.display = 'none';
                    emojiToggle.textContent = "üòä";
                    emojiToggle.setAttribute('aria-expanded', 'false');
                    wasPickerOpenBeforeKeyboard = true;
                }
                adjustLayoutForKeyboard();
                if (!rafId) rafId = requestAnimationFrame(updateLayout);
            });

            input.addEventListener("blur", () => {
                console.log("Input blurred");
                setTimeout(() => {
                    const isStillFocused = document.activeElement === input || document.activeElement === emojiToggle;
                    if (!isStillFocused) {
                        adjustLayoutForKeyboard();
                    }
                }, 50);
                if (wasPickerOpenBeforeKeyboard) {
                    emojiPicker.classList.add('show');
                    emojiPicker.style.display = 'block';
                    emojiToggle.textContent = "‚å®Ô∏è";
                    emojiToggle.setAttribute('aria-expanded', 'true');
                }
                if (rafId) {
                    cancelAnimationFrame(rafId);
                    rafId = null;
                }
            });

            input.addEventListener("input", debouncedAdjustLayout);
        });

        const themeToggle = document.getElementById("themeToggle");
        const handleThemeToggle = (e) => {
            e.preventDefault();
            console.log("Theme toggle clicked");
            document.body.classList.toggle("dark-mode");
            themeToggle.textContent = document.body.classList.contains("dark-mode") ? "‚òÄÔ∏è" : "üåô";
            if (window._emojiPickerInstance) {
                window._emojiPickerInstance.setOptions({
                    theme: document.body.classList.contains("dark-mode") ? "dark" : "light"
                });
            }
            localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
        };
        themeToggle.removeEventListener("click", handleThemeToggle);
        themeToggle.removeEventListener("touchstart", handleThemeToggle);
        themeToggle.addEventListener("click", handleThemeToggle, { passive: false });
        themeToggle.addEventListener("touchstart", handleThemeToggle, { passive: false });

        const shareBtn = document.getElementById("shareBtn");
        const shareSheet = document.getElementById("shareSheet");

        const handleShareBtn = (e) => {
            e.preventDefault();
            e.stopImmediatePropagation();
            console.log("Share button clicked");
            const btnRect = shareBtn.getBoundingClientRect();
            shareSheet.style.top = (btnRect.bottom + window.scrollY) + "px";
            shareSheet.style.right = (window.innerWidth - btnRect.right) + "px";
            shareSheet.classList.toggle('show');
            if (shareSheet.classList.contains('show')) shareSheet.style.display = 'flex';
            else setTimeout(() => { shareSheet.style.display = 'none'; }, 300);
        };
        shareBtn.removeEventListener("click", handleShareBtn);
        shareBtn.removeEventListener("touchstart", handleShareBtn);
        shareBtn.addEventListener("click", handleShareBtn, { passive: false });
        shareBtn.addEventListener("touchstart", handleShareBtn, { passive: false });

        document.addEventListener("click", (e) => {
            if (!shareSheet.contains(e.target) && e.target !== shareBtn && shareSheet.classList.contains('show')) {
                console.log("Closing share sheet");
                shareSheet.classList.remove('show');
                setTimeout(() => { shareSheet.style.display = 'none'; }, 300);
            }
        });
        document.addEventListener("touchstart", (e) => {
            if (!shareSheet.contains(e.target) && e.target !== shareBtn && shareSheet.classList.contains('show')) {
                console.log("Closing share sheet (touch)");
                shareSheet.classList.remove('show');
                setTimeout(() => { shareSheet.style.display = 'none'; }, 300);
            }
        });

        function shareApp(platform) {
            console.log(`Sharing on ${platform}`);
            let url = window.location.href;
            if (platform === "whatsapp") window.open("https://wa.me/?text=" + encodeURIComponent(url), "_blank");
            else if (platform === "instagram") window.open("https://www.instagram.com/", "_blank");
            else if (platform === "facebook") window.open("https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(url), "_blank");
            else if (platform === "x") window.open("https://twitter.com/intent/tweet?url=" + encodeURIComponent(url), "_blank");
            else if (platform === "link") {
                const tempInput = document.createElement('input');
                tempInput.value = url;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showCopyPopup("‚úÖ Copied!");
            }
        }

        function showCopyPopup(message) {
            console.log("Showing copy popup:", message);
            let existing = document.getElementById("copyLinkPopup");
            if (existing) existing.remove();
            const popup = document.createElement("div");
            popup.id = "copyLinkPopup";
            popup.textContent = message;
            document.body.appendChild(popup);
            const shareBtnRect = shareBtn.getBoundingClientRect();
            const sheetRect = shareSheet.getBoundingClientRect();
            popup.style.top = (sheetRect.bottom + window.scrollY + 10) + "px";
            popup.style.right = (window.innerWidth - sheetRect.right) + "px";
            popup.style.transform = 'translateY(-10px)';
            void popup.offsetWidth;
            popup.classList.add('show');
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => popup.remove(), 300);
            }, 2000);
        }

        function scrollToBottom() {
            const chatDiv = document.getElementById("chat");
            const isNearBottom = chatDiv.scrollHeight - chatDiv.scrollTop - chatDiv.clientHeight < 100;
            if (isNearBottom && messagesDiv.children.length > 0) {
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }
        }

        let hasStartedChat = false;
        let socket;
        let username = `User${Math.floor(Math.random() * 10000)}`;
        let isConnected = false;
        let typingTimeout;
        let lastKeyboardHeight = parseInt(localStorage.getItem('lastKeyboardHeight')) || 350;

        const SERVER_URL = "https://tiktalkchat-backend.onrender.com";

        async function checkServerStatus() {
            try {
                const response = await fetch(SERVER_URL, { method: 'GET', mode: 'cors' });
                console.log(`Server status: ${response.status}`);
                return response.ok;
            } catch (error) {
                console.error("Server check error:", error);
                return false;
            }
        }

        function adjustLayoutForKeyboard() {
            const header = document.querySelector("header");
            const chatDiv = document.getElementById("chat");
            const footerNote = document.querySelector(".footerNote");
            const footer = document.querySelector("footer");
            const startChattingBtn = document.getElementById("startChattingBtn");
            const nextBtn = document.getElementById("nextBtn");
            const emojiPicker = document.getElementById("emojiPicker");
            const headerHeight = header.offsetHeight || 70;
            let safeAreaTop = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-top') || '0', 10);
            let safeAreaBottom = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-bottom') || '0', 10);

            if (isNaN(safeAreaTop)) safeAreaTop = 0;
            if (isNaN(safeAreaBottom)) safeAreaBottom = 0;

            const isKeyboardOpen = document.activeElement === input;
            const isEmojiPickerOpen = emojiPicker.classList.contains('show');
            let keyboardHeight = 0;

            if ('virtualKeyboard' in navigator && navigator.virtualKeyboard.boundingRect.height > 0) {
                keyboardHeight = navigator.virtualKeyboard.boundingRect.height;
            } else if (window.visualViewport) {
                const visualViewportBottom = window.visualViewport.height + window.visualViewport.offsetTop;
                const windowBottom = window.innerHeight;
                keyboardHeight = Math.max(0, windowBottom - visualViewportBottom);
            }

            if (keyboardHeight > 0) {
                lastKeyboardHeight = Math.max(keyboardHeight, 300);
                localStorage.setItem('lastKeyboardHeight', lastKeyboardHeight);
            } else if (!isKeyboardOpen && !isEmojiPickerOpen) {
                lastKeyboardHeight = parseInt(localStorage.getItem('lastKeyboardHeight')) || 350;
            }

            document.documentElement.style.setProperty('--keyboard-height', `${lastKeyboardHeight}px`);
            document.documentElement.style.setProperty('--emoji-picker-height', `${lastKeyboardHeight}px`);

            const isDesktop = window.matchMedia("(min-width: 768px)").matches;
            const emojiPickerHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--emoji-picker-height')) || 350;

            footer.style.transition = 'none';

            if (isKeyboardOpen) {
                footer.style.bottom = `calc(${keyboardHeight}px + ${safeAreaBottom}px)`;
                chatDiv.style.paddingBottom = `calc(${footer.offsetHeight}px + ${keyboardHeight}px + ${safeAreaBottom}px + 10px)`;
                footerNote.style.bottom = `calc(${footer.offsetHeight}px + ${keyboardHeight}px + ${safeAreaBottom}px + 10px)`;
                if (!hasStartedChat) {
                    startChattingBtn.style.bottom = `calc(${footer.offsetHeight}px + ${keyboardHeight}px + ${safeAreaBottom}px + 60px)`;
                }
                nextBtn.style.bottom = `calc(${footer.offsetHeight}px + ${keyboardHeight}px + ${safeAreaBottom}px + 30px)`;
                emojiPicker.style.bottom = `calc(10px + ${safeAreaBottom}px)`;
            } else if (isEmojiPickerOpen) {
                footer.style.bottom = `calc(${emojiPickerHeight}px + ${safeAreaBottom}px)`;
                chatDiv.style.paddingBottom = `calc(${footer.offsetHeight}px + ${emojiPickerHeight}px + ${safeAreaBottom}px + 10px)`;
                footerNote.style.bottom = `calc(${footer.offsetHeight}px + ${emojiPickerHeight}px + ${safeAreaBottom}px + 10px)`;
                if (!hasStartedChat) {
                    startChattingBtn.style.bottom = `calc(${footer.offsetHeight}px + ${emojiPickerHeight}px + ${safeAreaBottom}px + 60px)`;
                }
                nextBtn.style.bottom = `calc(${footer.offsetHeight}px + ${emojiPickerHeight}px + ${safeAreaBottom}px + 30px)`;
                emojiPicker.style.bottom = `calc(10px + ${safeAreaBottom}px)`;
            } else {
                footer.style.bottom = `calc(10px + ${safeAreaBottom}px)`;
                chatDiv.style.paddingBottom = `calc(${footer.offsetHeight}px + ${safeAreaBottom}px + 10px)`;
                footerNote.style.bottom = `calc(${footer.offsetHeight}px + ${safeAreaBottom}px + 10px)`;
                if (!hasStartedChat) {
                    startChattingBtn.style.bottom = `calc(${footer.offsetHeight}px + ${safeAreaBottom}px + 60px)`;
                }
                nextBtn.style.bottom = `calc(${footer.offsetHeight}px + ${safeAreaBottom}px + 30px)`;
                emojiPicker.style.bottom = `calc(10px + ${safeAreaBottom}px)`;
            }

            header.style.top = `calc(0px + ${safeAreaTop}px)`;
            chatDiv.style.marginTop = `calc(${headerHeight}px + ${safeAreaTop}px)`;
            chatDiv.style.height = `calc(100vh - ${headerHeight}px - ${safeAreaBottom}px)`;

            requestAnimationFrame(() => {
                footer.style.transition = 'bottom 0.3s ease';
                scrollToBottom();
            });
        }

        const debouncedAdjustLayout = debounce(adjustLayoutForKeyboard, 50);
        let rafId;
        function updateLayout() {
            adjustLayoutForKeyboard();
            rafId = requestAnimationFrame(updateLayout);
        }

        if (window.visualViewport && !('virtualKeyboard' in navigator)) {
            window.visualViewport.addEventListener("resize", () => {
                const visualViewportBottom = window.visualViewport.height + window.visualViewport.offsetTop;
                const windowBottom = window.innerHeight;
                const keyboardHeight = windowBottom - visualViewportBottom;
                if (keyboardHeight === 0 && document.activeElement !== input) {
                    adjustLayoutForKeyboard();
                } else {
                    debouncedAdjustLayout();
                }
            });
            window.visualViewport.addEventListener("scroll", debouncedAdjustLayout);
        }

        setInterval(() => {
            const isKeyboardOpen = document.activeElement === input;
            const isEmojiPickerOpen = emojiPicker.classList.contains('show');
            let keyboardHeight = 0;
            if ('virtualKeyboard' in navigator) {
                keyboardHeight = navigator.virtualKeyboard.boundingRect.height;
            } else if (window.visualViewport) {
                const visualViewportBottom = window.visualViewport.height + window.visualViewport.offsetTop;
                const windowBottom = window.innerHeight;
                keyboardHeight = Math.max(0, windowBottom - visualViewportBottom);
            }
            if (!isKeyboardOpen && keyboardHeight === 0 && !isEmojiPickerOpen) {
                adjustLayoutForKeyboard();
            }
        }, 500);

        window.addEventListener("resize", debouncedAdjustLayout);
        window.addEventListener("touchstart", debouncedAdjustLayout);
        window.addEventListener("touchmove", debouncedAdjustLayout);
        window.addEventListener("load", debouncedAdjustLayout);

        const messagesDiv = document.getElementById("messages");
        const input = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");
        const startChattingBtn = document.getElementById("startChattingBtn");
        const nextBtn = document.getElementById("nextBtn");
        const typingIndicator = document.getElementById("typingIndicator");

        function addMessage(text, who) {
            const fragment = document.createDocumentFragment();
            const div = document.createElement("div");
            div.className = "msg " + who;
            div.textContent = text;
            fragment.appendChild(div);
            messagesDiv.appendChild(fragment);
            scrollToBottom();
            if (hasStartedChat) {
                startChattingBtn.style.display = 'none';
            }
            debouncedAdjustLayout();
            console.log(`Message added: ${text} (${who})`);
        }

        function showPopup(text) {
            if (text.includes("Searching")) {
                messagesDiv.innerHTML = `
                    <div class="popup">
                        <div class="searching-container">
                            <div class="pulse-dots"><div class="pulse-dot"></div><div class="pulse-dot"></div><div class="pulse-dot"></div></div>
                            <div class="searching-text">Searching for a stranger...</div>
                        </div>
                    </div>`;
                isConnected = false;
                if (hasStartedChat) {
                    startChattingBtn.style.display = 'none';
                }
                nextBtn.style.display = 'block';
                console.log("Showing searching popup");
            } else if (text.includes("Connected")) {
                messagesDiv.innerHTML = `
                    <div class="popup"><span class="connected-checkmark"></span><span>Connected! Say Hi üëã</span></div>`;
                isConnected = true;
                if (hasStartedChat) {
                    startChattingBtn.style.display = 'none';
                }
                nextBtn.style.display = 'block';
                setTimeout(() => {
                    if (messagesDiv.innerHTML.includes("Connected")) messagesDiv.innerHTML = '';
                }, 3000);
                console.log("Showing connected popup");
            } else {
                messagesDiv.innerHTML = `<div class="popup">${text}</div>`;
                isConnected = false;
                if (hasStartedChat) {
                    startChattingBtn.style.display = 'none';
                }
                nextBtn.style.display = 'block';
                console.log(`Showing popup: ${text}`);
            }
            scrollToBottom();
            debouncedAdjustLayout();
        }

        async function connectStranger() {
            if (socket && socket.connected) {
                socket.disconnect();
                console.log("Disconnected existing socket");
            }

            const serverAvailable = await checkServerStatus();
            if (!serverAvailable) {
                showPopup("‚ùå Server is unavailable. Please try again later or refresh the page.");
                nextBtn.style.display = 'block';
                console.error("Server unavailable");
                return;
            }

            showPopup("üîç Searching for a stranger...");
            typingIndicator.style.display = "none";
            socket = io(SERVER_URL, {
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });

            socket.on('connect', () => {
                console.log("Socket connected:", socket.id);
                socket.emit('startChat', { username });
                hasStartedChat = true;
                nextBtn.style.display = 'block';
                debouncedAdjustLayout();
            });

            socket.on('system', (data) => {
                console.log("System message:", data.text);
                showPopup(data.text);
            });

            socket.on('receiveMessage', (data) => {
                console.log("Message received:", data.message);
                typingIndicator.style.display = "none";
                addMessage(data.message, "stranger");
            });

            socket.on('typing', (data) => {
                if (isConnected) {
                    console.log("Typing indicator received");
                    typingIndicator.style.display = "block";
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        typingIndicator.style.display = "none";
                    }, 1500);
                }
            });

            socket.on('disconnect', () => {
                console.log("Socket disconnected");
                isConnected = false;
                typingIndicator.style.display = "none";
                showPopup("‚ùå Disconnected from server");
                nextBtn.style.display = 'block';
                debouncedAdjustLayout();
            });

            socket.on('connect_error', (error) => {
                console.error("Socket connect error:", error);
                showPopup("‚ùå Connection error. Please try again.");
                nextBtn.style.display = 'block';
            });
        }

        const handleStartChatting = async (e) => {
            e.preventDefault();
            e.stopImmediatePropagation();
            console.log("Start Chatting button clicked");
            hasStartedChat = true;
            startChattingBtn.style.display = 'none';
            await connectStranger();
        };
        startChattingBtn.removeEventListener("click", handleStartChatting);
        startChattingBtn.removeEventListener("touchstart", handleStartChatting);
        startChattingBtn.addEventListener("click", handleStartChatting, { passive: false });
        startChattingBtn.addEventListener("touchstart", handleStartChatting, { passive: false });

        const handleSend = (e) => {
            e.preventDefault();
            e.stopImmediatePropagation();
            console.log("Send button clicked");
            if (isConnected && socket && socket.connected && input.value.trim()) {
                socket.emit('sendMessage', { message: input.value, username });
                addMessage(input.value, "me");
                input.value = "";
                emojiPicker.classList.remove('show');
                emojiPicker.style.display = 'none';
                document.getElementById("emojiToggle").textContent = "üòä";
                document.getElementById("emojiToggle").setAttribute('aria-expanded', 'false');
                wasPickerOpenBeforeKeyboard = false;
                debouncedAdjustLayout();
            } else if (!isConnected) {
                showPopup("‚ùå Not connected to a stranger. Please try again.");
                console.log("Send failed: not connected");
            }
        };
        sendBtn.removeEventListener("click", handleSend);
        sendBtn.removeEventListener("touchstart", handleSend);
        sendBtn.addEventListener("click", handleSend, { passive: false });
        sendBtn.addEventListener("touchstart", handleSend, { passive: false });

        const handleNext = async (e) => {
            e.preventDefault();
            e.stopImmediatePropagation();
            console.log("Next button clicked");
            if (socket && socket.connected) {
                socket.emit('nextChat');
                console.log("Next chat requested");
            } else {
                const serverAvailable = await checkServerStatus();
                if (serverAvailable) {
                    await connectStranger();
                } else {
                    showPopup("‚ùå Server is unavailable. Please try again later.");
                    nextBtn.style.display = 'block';
                    console.error("Server unavailable for next chat");
                }
            }
            debouncedAdjustLayout();
        };
        nextBtn.removeEventListener("click", handleNext);
        nextBtn.removeEventListener("touchstart", handleNext);
        nextBtn.addEventListener("click", handleNext, { passive: false });
        nextBtn.addEventListener("touchstart", handleNext, { passive: false });

        input.addEventListener("input", () => {
            if (isConnected && socket && socket.connected) {
                socket.emit('typing', { username });
                console.log("Typing event emitted");
            }
        });

        document.body.classList.add('auto-scroll-enabled');
        const observer = new MutationObserver(() => {
            scrollToBottom();
        });
        observer.observe(messagesDiv, { childList: true, subtree: true });

        if (!hasStartedChat) {
            startChattingBtn.style.display = 'block';
        }
        messagesDiv.innerHTML = '';
        console.log("App initialized");
    </script>
</body>
</html>