<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>TikTalk - Stranger Chat</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-mart@latest/css/emoji-mart.css" />
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Arial, sans-serif;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
body {
  background: #fff;
  display: flex;
  flex-direction: column;
  height: 100vh;
  transition: background 0.3s, color 0.3s;
  color: #0f172a;
  overflow: auto;
  position: relative;
  overscroll-behavior-y: none;
}
body.dark-mode {
  background: #0b0f15;
  color: #e5e7eb;
}
header {
  position: fixed !important;
  top: env(safe-area-inset-top);
  left: 0;
  right: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 10px;
  background: #fff;
  z-index: 10003;
  width: 100%;
  box-sizing: border-box;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border-radius: 0 0 16px 16px;
}
body.dark-mode header {
  background: #10161d;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
header .left, header .right {
  display: flex;
  align-items: center;
  gap: 8px;
}
header svg.logo {
  height: 60px;
  width: auto;
  display: block;
}
.chat-wrapper {
  position: relative;
  flex: 1;
  overflow: auto;
}
#chat {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  overflow-y: auto;
  overscroll-behavior: contain;
  contain: strict;
  padding: calc(70px + env(safe-area-inset-top)) 15px calc(70px + env(safe-area-inset-bottom));
  -webkit-overflow-scrolling: touch;
}
#messages {
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-height: 100%;
}
.msg {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 18px;
  word-wrap: break-word;
  font-size: 15px;
  line-height: 1.4;
  box-shadow: 0 1px 2px rgba(0,0,0,0.06);
  display: inline-block;
}
.me {
  align-self: flex-end;
  background: #e6f0ff;
  color: #0f172a;
  border-bottom-right-radius: 6px;
}
body.dark-mode .me {
  background: #2a3d66;
}
.stranger {
  align-self: flex-start;
  background: #f0f0f5;
  color: #0f172a;
  border-bottom-left-radius: 6px;
}
body.dark-mode .stranger {
  background: #2d3748;
}
.popup {
  background: transparent;
  border: none;
  padding: 8px;
  text-align: center;
  color: #555;
  max-width: 220px;
  margin: 8px auto;
  font-size: 14px;
}
body.dark-mode .popup {
  background: transparent;
  color: #e5e7eb;
}
#typingIndicator {
  font-size: 13px;
  color: #888;
  margin-top: 5px;
  text-align: left;
  display: none;
}
body.dark-mode #typingIndicator {
  color: #b0b0b0;
}
.typing-container {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 6px;
}
.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: linear-gradient(45deg, #007bff, #00eaff);
  animation: typingBounce 1.2s ease-in-out infinite;
}
.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}
footer {
  position: fixed !important;
  bottom: calc(10px + env(safe-area-inset-bottom));
  left: 8px;
  right: 8px;
  display: flex;
  align-items: center;
  padding: 6px;
  gap: 8px;
  background: #fff;
  z-index: 10000;
  height: 56px;
  min-height: 56px;
  max-height: 56px;
  box-sizing: border-box;
  border-radius: 35px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  transition: bottom 0.3s ease;
}
body.dark-mode footer {
  background: #10161d;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
}
.footerNote {
  position: fixed;
  bottom: calc(72px + env(safe-area-inset-bottom));
  left: 0;
  right: 0;
  text-align: center;
  font-size: 14px;
  color: #555;
  z-index: 9999;
}
body.dark-mode .footerNote {
  color: #e5e7eb;
}
.inputWrapper {
  flex: 1;
  position: relative;
  display: flex;
  align-items: center;
  height: 40px;
  min-height: 40px;
  max-height: 40px;
  background: transparent;
}
textarea {
  width: 100%;
  resize: none;
  padding: 10px 18px 10px 12px;
  border: 1px solid #ccc;
  border-radius: 20px;
  font-size: 14px;
  outline: none;
  height: 40px;
  min-height: 40px;
  max-height: 120px;
  line-height: 18px;
  background: transparent;
  color: #0f172a;
  overflow-y: auto;
  box-sizing: border-box;
}
body.dark-mode textarea {
  border: 1px solid #4a5568;
  color: #e5e7eb;
}
#emojiToggle {
  border: none;
  font-size: 20px;
  cursor: pointer;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
}
body.dark-mode #emojiToggle {
  color: #e5e7eb;
}
button {
  padding: 0 14px;
  border: none;
  border-radius: 20px;
  background: #007bff;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  font-size: 14px;
}
#sendBtn {
  width: 46px;
  height: 46px;
  border-radius: 50%;
  background: #007bff;
  display: flex;
  align-items: center;
  justify-content: center;
}
#nextBtn {
  position: fixed;
  bottom: calc(100px + env(safe-area-inset-bottom));
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: #ff3b30;
  display: none;
}
#emojiPicker {
  position: fixed;
  left: 8px;
  right: 8px;
  margin: 0 auto;
  width: calc(100% - 16px);
  max-width: 400px;
  height: var(--emoji-picker-height, 350px);
  max-height: 50vh;
  overflow-y: auto;
  background: transparent;
  border-radius: 16px;
  z-index: 10001;
  opacity: 0;
  display: none;
  transform: translateY(30px) scale(0.98);
}
#emojiPicker.show {
  opacity: 1;
  display: block;
  transform: translateY(0) scale(1);
}
.emoji-mart {
  width: 100% !important;
  height: 100% !important;
  overflow-y: auto !important;
  border-radius: 16px;
}
.start-chatting-btn {
  position: fixed;
  bottom: calc(130px + env(safe-area-inset-bottom));
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 24px;
  background: #007bff;
  color: #fff;
  border: none;
  border-radius: 25px;
  font-weight: bold;
  font-size: 16px;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  z-index: 10001;
  animation: pulse-glow 2s infinite;
}
body.dark-mode .start-chatting-btn {
  background: #007bff;
  box-shadow: 0 4px 15px rgba(0,123,255,0.4);
}
@keyframes pulse-glow {
  0% { box-shadow: 0 4px 15px rgba(0,123,255,0.4); transform: translateX(-50%) scale(1); }
  50% { box-shadow: 0 4px 20px rgba(0,123,255,0.7); transform: translateX(-50%) scale(1.05); }
  100% { box-shadow: 0 4px 15px rgba(0,123,255,0.4); transform: translateX(-50%) scale(1); }
}
.icon-btn {
  width: 28px;
  height: 28px;
  font-size: 20px;
  border-radius: 50%;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: none;
}
.share-btn {
  padding: 0;
  background: transparent;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  position: relative;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  z-index: 10005;
  visibility: visible;
  opacity: 1;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.share-btn svg.button-icon {
  width: 12px;
  height: 12px;
}
.share-animation {
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10006;
  pointer-events: none;
}
.share-animation::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: 50%;
  padding: 2px;
  background: linear-gradient(45deg, #00eaff, #007bff, #6a00ff, #00eaff);
  background-size: 300% 300%;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  animation: shareBorderAnimation 3s ease infinite;
}
@keyframes shareBorderAnimation {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
.share-sheet {
  position: absolute;
  top: calc(100% + env(safe-area-inset-top));
  right: 0;
  background: #fff;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  display: none;
  flex-direction: row;
  gap: 12px;
  z-index: 10006;
  margin-top: 5px;
  transform: translateY(-10px);
  opacity: 0;
  transition: all 0.3s ease;
}
.share-sheet.show {
  transform: translateY(0);
  opacity: 1;
  display: flex;
}
body.dark-mode .share-sheet {
  background: #1f2937;
}
.share-sheet button {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 50%;
  padding: 8px;
  width: 44px;
  height: 44px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}
.share-sheet button img, .share-sheet button svg {
  width: 24px;
  height: 24px;
  display: block; /* Ensure SVG/image is visible */
}
.share-sheet button.x-btn {
  background: #000; /* Temporary for debugging to ensure visibility */
}
body.dark-mode .share-sheet button {
  background: #2d3748;
}
.share-sheet .link {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  color: #007bff;
  font-weight: 600;
}
#copyLinkPopup {
  position: absolute;
  top: calc(100% + 15px);
  right: 0;
  padding: 12px 20px;
  border-radius: 25px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  font-size: 14px;
  font-weight: 600;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 10007;
  pointer-events: none;
  color: #fff;
  background: #007bff;
  transform: translateY(-10px);
}
#copyLinkPopup.show {
  opacity: 1;
  transform: translateY(0);
}
</style>
</head>
<body>
<header>
  <div class="left">
    <svg class="logo" width="auto" height="60" viewBox="0 0 420 140" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="TikTalk animated logo">
      <defs>
        <linearGradient id="gBubble" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#00eaff">
            <animate attributeName="stop-color" dur="6s" values="#00eaff;#007bff;#6a00ff;#00eaff" repeatCount="indefinite"/>
          </stop>
          <stop offset="100%" stop-color="#007bff">
            <animate attributeName="stop-color" dur="6s" values="#007bff;#6a00ff;#00eaff;#007bff" repeatCount="indefinite"/>
          </stop>
        </linearGradient>
        <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="6" result="b"/>
          <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <g transform="translate(60,70) scale(1.2)">
        <circle cx="0" cy="0" r="45" fill="url(#gBubble)"/>
        <ellipse class="eye left" cx="-12" cy="-9" rx="4.5" ry="7" fill="#fff"/>
        <path class="right" d="M 8 -9 Q 12 -13 16 -9" stroke="#fff" stroke-width="2.5" stroke-linecap="round" fill="none"/>
        <path class="smile" d="M -10 10 Q 0 18 10 10" stroke="#fff" stroke-width="2" stroke-linecap="round" fill="none"/>
      </g>
      <text x="120" y="70" font-size="56" font-family="Segoe UI, Arial, sans-serif" font-weight="800" fill="#007bff" dominant-baseline="middle" alignment-baseline="middle">TikTalk</text>
    </svg>
  </div>
  <div class="right">
    <button id="themeToggle" class="icon-btn">🌙</button>
    <div style="position: relative;">
      <button id="shareBtn" class="share-btn">
        <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
          <path d="M18 8l-8 8-8-8"/>
          <animate attributeName="stroke" values="#007bff;#00eaff;#6a00ff;#007bff" dur="3s" repeatCount="indefinite"/>
          <animate attributeName="transform" values="scale(1);scale(1.1);scale(1)" dur="1.5s" repeatCount="indefinite"/>
        </svg>
      </button>
      <div class="share-animation"></div>
    </div>
    <div class="share-sheet" id="shareSheet">
      <button onclick="shareApp('whatsapp')"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"></button>
      <button onclick="shareApp('instagram')"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" alt="Instagram"></button>
      <button onclick="shareApp('facebook')"><img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_%282019%29.png" alt="Facebook"></button>
      <button onclick="shareApp('x')" class="x-btn">
        <svg viewBox="0 0 24 24" fill="#fff">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
        <!-- Fallback: Uncomment below if the original logo was an image -->
        <!-- <img src="https://upload.wikimedia.org/wikipedia/commons/3/3a/X_icon_2023.svg" alt="X"> -->
      </button>
      <button class="link" onclick="shareApp('link')">🔗</button>
    </div>
  </div>
</header>
<div class="chat-wrapper">
  <main id="chat">
    <div id="messages">
      <div class="popup">Welcome to TikTalk! Click "Start Chat" to connect with a stranger.</div>
    </div>
    <div id="typingIndicator" style="display:none;">
      <div class="typing-container">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
  </main>
</div>
<button id="startChattingBtn" class="start-chatting-btn">Start Chat</button>
<p class="footerNote">Made in India <span class="heart">♥️</span></p>
<footer>
  <button id="emojiToggle" aria-label="Toggle emoji picker">😊</button>
  <div class="inputWrapper">
    <textarea id="messageInput" placeholder="Type a message..."></textarea>
  </div>
  <button id="sendBtn" title="Send">
    <svg class="button-icon" viewBox="0 0 24 24" fill="white">
      <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
    </svg>
  </button>
</footer>
<button id="nextBtn" title="Next">
  <svg class="button-icon" viewBox="0 0 24 24" fill="white">
    <path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/>
  </svg>
</button>
<div id="emojiPicker" aria-hidden="true"></div>
<script>
window.TIKTALK_BACKEND = "https://tiktalkchat-backend-v2.onrender.com";

function debounce(func, wait) {
  let timeout;
  return function (...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

document.addEventListener("DOMContentLoaded", () => {
  console.log("DOM loaded, initializing UI...");
  const shareBtn = document.getElementById("shareBtn");
  const messagesDiv = document.getElementById("messages");
  const startChattingBtn = document.getElementById("startChattingBtn");
  const input = document.getElementById("messageInput");
  const emojiToggle = document.getElementById("emojiToggle");
  const emojiPicker = document.getElementById("emojiPicker");
  const sendBtn = document.getElementById("sendBtn");
  const nextBtn = document.getElementById("nextBtn");
  const themeToggle = document.getElementById("themeToggle");

  // Ensure initial UI state
  if (shareBtn) {
    shareBtn.style.display = "flex";
    shareBtn.style.visibility = "visible";
    shareBtn.style.opacity = "1";
  } else {
    console.error("Share Button not found!");
  }
  if (startChattingBtn) {
    startChattingBtn.style.display = "block";
  } else {
    console.error("Start Chatting Button not found!");
  }
  messagesDiv.innerHTML = '<div class="popup">Welcome to TikTalk! Click "Start Chat" to connect with a stranger.</div>';

  // Theme toggle
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "dark") {
    document.body.classList.add("dark-mode");
    themeToggle.textContent = "☀️";
  }

  // Virtual keyboard support
  if ('virtualKeyboard' in navigator) {
    navigator.virtualKeyboard.overlaysContent = true;
    navigator.virtualKeyboard.addEventListener('geometrychange', debouncedAdjustLayout);
  }

  // Emoji picker initialization
  function initializeEmojiPicker() {
    try {
      const script = document.createElement("script");
      script.src = "https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js";
      script.onload = () => {
        if (window.EmojiMart) {
          const picker = new window.EmojiMart.Picker({
            onEmojiSelect: (e) => {
              if (!emojiPicker.classList.contains('show') || document.activeElement !== input) return;
              input.value += e.native;
              input.focus();
              debouncedAdjustLayout();
            },
            theme: document.body.classList.contains("dark-mode") ? "dark" : "light",
            previewPosition: "none",
            skinTonePosition: "search",
            categories: ["frequent", "people", "nature", "foods", "activity", "places", "objects", "symbols", "flags"],
            emoji: "😊"
          });
          emojiPicker.appendChild(picker);
          window._emojiPickerInstance = picker;
        } else {
          console.error("EmojiMart not loaded");
        }
      };
      script.onerror = () => console.error("Failed to load EmojiMart");
      document.head.appendChild(script);
    } catch (error) {
      console.error("Error initializing EmojiPicker:", error);
    }
  }
  initializeEmojiPicker();

  // Emoji toggle
  let wasPickerOpenBeforeKeyboard = false;
  const handleEmojiToggle = (e) => {
    console.log("Emoji toggle clicked");
    e.preventDefault();
    const isPickerOpen = emojiPicker.classList.contains('show');
    emojiPicker.classList.toggle('show');
    emojiPicker.style.display = isPickerOpen ? 'none' : 'block';
    emojiToggle.textContent = isPickerOpen ? "😊" : "⌨️";
    emojiToggle.setAttribute('aria-expanded', !isPickerOpen);
    if (!isPickerOpen) input.blur();
    else input.focus();
    wasPickerOpenBeforeKeyboard = isPickerOpen;
    debouncedAdjustLayout();
  };
  emojiToggle.removeEventListener("click", handleEmojiToggle);
  emojiToggle.removeEventListener("touchstart", handleEmojiToggle);
  emojiToggle.addEventListener("click", handleEmojiToggle);
  emojiToggle.addEventListener("touchstart", handleEmojiToggle, { passive: false });

  // Input interaction
  input.addEventListener("focus", () => {
    console.log("Input focused");
    if (emojiPicker.classList.contains('show')) {
      emojiPicker.classList.remove('show');
      emojiPicker.style.display = 'none';
      emojiToggle.textContent = "😊";
      emojiToggle.setAttribute('aria-expanded', 'false');
      wasPickerOpenBeforeKeyboard = true;
    }
    adjustLayoutForKeyboard();
    if (!rafId) rafId = requestAnimationFrame(updateLayout);
  });

  input.addEventListener("blur", () => {
    console.log("Input blurred");
    setTimeout(() => {
      if (document.activeElement !== input && document.activeElement !== emojiToggle) {
        adjustLayoutForKeyboard();
      }
    }, 50);
    if (wasPickerOpenBeforeKeyboard) {
      emojiPicker.classList.add('show');
      emojiPicker.style.display = 'block';
      emojiToggle.textContent = "⌨️";
      emojiToggle.setAttribute('aria-expanded', 'true');
    }
    if (rafId) {
      cancelAnimationFrame(rafId);
      rafId = null;
    }
  });

  input.addEventListener("input", debouncedAdjustLayout);
});

// Theme toggle
const themeToggle = document.getElementById("themeToggle");
const handleThemeToggle = (e) => {
  console.log("Theme toggle clicked");
  e.preventDefault();
  document.body.classList.toggle("dark-mode");
  themeToggle.textContent = document.body.classList.contains("dark-mode") ? "☀️" : "🌙";
  if (window._emojiPickerInstance) {
    window._emojiPickerInstance.setOptions({
      theme: document.body.classList.contains("dark-mode") ? "dark" : "light"
    });
  }
  localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
};
themeToggle.removeEventListener("click", handleThemeToggle);
themeToggle.removeEventListener("touchstart", handleThemeToggle);
themeToggle.addEventListener("click", handleThemeToggle);
themeToggle.addEventListener("touchstart", handleThemeToggle, { passive: false });

// Share button
const shareBtn = document.getElementById("shareBtn");
const shareSheet = document.getElementById("shareSheet");
const handleShareBtn = (e) => {
  console.log("Share button clicked");
  e.preventDefault();
  const btnRect = shareBtn.getBoundingClientRect();
  shareSheet.style.top = (btnRect.bottom + window.scrollY) + "px";
  shareSheet.style.right = (window.innerWidth - btnRect.right) + "px";
  shareSheet.classList.toggle('show');
  shareSheet.style.display = shareSheet.classList.contains('show') ? 'flex' : 'none';
};
shareBtn.removeEventListener("click", handleShareBtn);
shareBtn.removeEventListener("touchstart", handleShareBtn);
shareBtn.addEventListener("click", handleShareBtn);
shareBtn.addEventListener("touchstart", handleShareBtn, { passive: false });

document.addEventListener("click", (e) => {
  if (!shareSheet.contains(e.target) && e.target !== shareBtn && shareSheet.classList.contains('show')) {
    shareSheet.classList.remove('show');
    shareSheet.style.display = 'none';
  }
});

function shareApp(platform) {
  console.log("Share app:", platform);
  let url = window.location.href;
  if (platform === "whatsapp") window.open("https://wa.me/?text=" + encodeURIComponent(url), "_blank");
  else if (platform === "instagram") window.open("https://www.instagram.com/", "_blank");
  else if (platform === "facebook") window.open("https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(url), "_blank");
  else if (platform === "x") window.open("https://twitter.com/intent/tweet?url=" + encodeURIComponent(url), "_blank");
  else if (platform === "link") {
    const tempInput = document.createElement('input');
    tempInput.value = url;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    showCopyPopup("✅ Copied!");
  }
}

function showCopyPopup(message) {
  console.log("Showing copy popup:", message);
  let existing = document.getElementById("copyLinkPopup");
  if (existing) existing.remove();
  const popup = document.createElement("div");
  popup.id = "copyLinkPopup";
  popup.textContent = message;
  document.body.appendChild(popup);
  const shareBtnRect = shareBtn.getBoundingClientRect();
  const sheetRect = shareSheet.getBoundingClientRect();
  popup.style.top = (sheetRect.bottom + window.scrollY + 10) + "px";
  popup.style.right = (window.innerWidth - sheetRect.right) + "px";
  popup.style.transform = 'translateY(-10px)';
  void popup.offsetHeight;
  popup.classList.add('show');
  setTimeout(() => {
    popup.classList.remove('show');
    popup.remove();
  }, 2000);
}

let ws, typingTimeout, isConnected = false, reconnectAttempts = 0, rafId;
const maxReconnectAttempts = 5;
let lastKeyboardHeight = parseInt(localStorage.getItem('lastKeyboardHeight')) || 350;

function adjustLayoutForKeyboard() {
  console.log("Adjusting layout for keyboard...");
  const header = document.querySelector("header");
  const chatDiv = document.getElementById("chat");
  const footerNote = document.querySelector(".footerNote");
  const footer = document.querySelector("footer");
  const startChattingBtn = document.getElementById("startChattingBtn");
  const nextBtn = document.getElementById("nextBtn");
  const emojiPicker = document.getElementById("emojiPicker");
  const headerHeight = header.offsetHeight || 70;
  let safeAreaTop = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-top') || '0', 10);
  let safeAreaBottom = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-bottom') || '0', 10);
  const isKeyboardOpen = document.activeElement === document.getElementById("messageInput");
  const isEmojiPickerOpen = emojiPicker.classList.contains('show');
  let keyboardHeight = 0;

  if ('virtualKeyboard' in navigator) {
    keyboardHeight = navigator.virtualKeyboard.boundingRect.height || 0;
  } else if (window.visualViewport) {
    const visualViewportBottom = window.visualViewport.height + window.visualViewport.offsetTop;
    const windowBottom = window.innerHeight;
    keyboardHeight = Math.max(0, windowBottom - visualViewportBottom);
  }

  if (keyboardHeight > 0) {
    lastKeyboardHeight = Math.max(keyboardHeight, 300);
    localStorage.setItem('lastKeyboardHeight', lastKeyboardHeight);
  } else if (!isKeyboardOpen && !isEmojiPickerOpen) {
    lastKeyboardHeight = parseInt(localStorage.getItem('lastKeyboardHeight')) || 350;
  }

  document.documentElement.style.setProperty('--keyboard-height', `${lastKeyboardHeight}px`);
  document.documentElement.style.setProperty('--emoji-picker-height', `${lastKeyboardHeight}px`);

  if (isKeyboardOpen) {
    footer.style.transition = 'bottom 0.3s ease';
    footer.style.bottom = `calc(${keyboardHeight}px + ${safeAreaBottom}px + 10px)`;
    chatDiv.style.paddingBottom = `calc(${footer.offsetHeight}px + ${keyboardHeight}px + ${safeAreaBottom}px + 10px)`;
    footerNote.style.bottom = `calc(${footer.offsetHeight}px + ${keyboardHeight}px + ${safeAreaBottom}px + 10px)`;
    startChattingBtn.style.bottom = `calc(${footer.offsetHeight}px + ${keyboardHeight}px + ${safeAreaBottom}px + 60px)`;
    nextBtn.style.bottom = `calc(${footer.offsetHeight}px + ${keyboardHeight}px + ${safeAreaBottom}px + 30px)`;
    if (emojiPicker.classList.contains('show')) {
      emojiPicker.classList.remove('show');
      emojiPicker.style.display = 'none';
      document.getElementById("emojiToggle").textContent = "😊";
      document.getElementById("emojiToggle").setAttribute('aria-expanded', 'false');
    }
  } else if (isEmojiPickerOpen) {
    const emojiPickerHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--emoji-picker-height')) || 350;
    footer.style.transition = 'bottom 0.3s ease';
    footer.style.bottom = `calc(${emojiPickerHeight}px + ${safeAreaBottom}px + 10px)`;
    chatDiv.style.paddingBottom = `calc(${footer.offsetHeight}px + ${emojiPickerHeight}px + ${safeAreaBottom}px + 10px)`;
    footerNote.style.bottom = `calc(${footer.offsetHeight}px + ${emojiPickerHeight}px + ${safeAreaBottom}px + 10px)`;
    startChattingBtn.style.bottom = `calc(${footer.offsetHeight}px + ${emojiPickerHeight}px + ${safeAreaBottom}px + 60px)`;
    nextBtn.style.bottom = `calc(${footer.offsetHeight}px + ${emojiPickerHeight}px + ${safeAreaBottom}px + 30px)`;
    emojiPicker.style.bottom = `calc(10px + ${safeAreaBottom}px)`;
  } else {
    footer.style.transition = 'none';
    footer.style.bottom = `calc(10px + ${safeAreaBottom}px)`;
    chatDiv.style.paddingBottom = `calc(${footer.offsetHeight}px + ${safeAreaBottom}px + 10px)`;
    footerNote.style.bottom = `calc(${footer.offsetHeight}px + ${safeAreaBottom}px + 10px)`;
    startChattingBtn.style.bottom = `calc(${footer.offsetHeight}px + 60px + ${safeAreaBottom}px)`;
    nextBtn.style.bottom = `calc(${footer.offsetHeight}px + 30px + ${safeAreaBottom}px)`;
    emojiPicker.style.bottom = `calc(10px + ${safeAreaBottom}px)`;
    footer.offsetHeight;
    setTimeout(() => {
      footer.style.transition = 'bottom 0.3s ease';
    }, 0);
  }

  footer.style.position = 'fixed';
  footer.style.transform = 'none';
  chatDiv.style.marginTop = `calc(${headerHeight}px + ${safeAreaTop}px)`;
  chatDiv.style.height = `calc(100vh - ${headerHeight}px - ${safeAreaBottom}px)`;
  requestAnimationFrame(() => {
    footer.offsetHeight;
    scrollToBottom();
  });
}

const debouncedAdjustLayout = debounce(adjustLayoutForKeyboard, 50);

function updateLayout() {
  adjustLayoutForKeyboard();
  rafId = requestAnimationFrame(updateLayout);
}

if (window.visualViewport && !('virtualKeyboard' in navigator)) {
  window.visualViewport.addEventListener("resize", () => {
    const visualViewportBottom = window.visualViewport.height + window.visualViewport.offsetTop;
    const windowBottom = window.innerHeight;
    const keyboardHeight = windowBottom - visualViewportBottom;
    if (keyboardHeight === 0 && document.activeElement !== document.getElementById("messageInput")) {
      adjustLayoutForKeyboard();
    } else {
      debouncedAdjustLayout();
    }
  });
  window.visualViewport.addEventListener("scroll", debouncedAdjustLayout);
}

setInterval(() => {
  const isKeyboardOpen = document.activeElement === document.getElementById("messageInput");
  const isEmojiPickerOpen = document.getElementById("emojiPicker").classList.contains('show');
  let keyboardHeight = 0;
  if ('virtualKeyboard' in navigator) {
    keyboardHeight = navigator.virtualKeyboard.boundingRect.height;
  } else if (window.visualViewport) {
    const visualViewportBottom = window.visualViewport.height + window.visualViewport.offsetTop;
    const windowBottom = window.innerHeight;
    keyboardHeight = Math.max(0, windowBottom - visualViewportBottom);
  }
  if (!isKeyboardOpen && keyboardHeight === 0 && !isEmojiPickerOpen) {
    adjustLayoutForKeyboard();
  }
}, 500);

window.addEventListener("resize", debouncedAdjustLayout);
window.addEventListener("touchstart", debouncedAdjustLayout);
window.addEventListener("touchmove", debouncedAdjustLayout);
window.addEventListener("load", debouncedAdjustLayout);

function scrollToBottom() {
  const chatDiv = document.getElementById("chat");
  const isNearBottom = chatDiv.scrollHeight - chatDiv.scrollTop - chatDiv.clientHeight < 100;
  if (isNearBottom && messagesDiv.children.length > 0) {
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }
}

const messagesDiv = document.getElementById("messages");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const startChattingBtn = document.getElementById("startChattingBtn");
const nextBtn = document.getElementById("nextBtn");
const typingIndicator = document.getElementById("typingIndicator");

function addMessage(text, who) {
  console.log("Adding message:", text, who);
  const div = document.createElement("div");
  div.className = "msg " + who;
  div.textContent = text;
  messagesDiv.appendChild(div);
  scrollToBottom();
  startChattingBtn.style.display = 'none';
  debouncedAdjustLayout();
}

function showPopup(text) {
  console.log("Showing popup:", text);
  messagesDiv.innerHTML = `<div class="popup">${text}</div>`;
  if (text.includes("Searching")) {
    messagesDiv.innerHTML = `
      <div class="popup">
        <div class="searching-container">
          <div class="pulse-dots"><div class="pulse-dot"></div><div class="pulse-dot"></div><div class="pulse-dot"></div></div>
          <div class="searching-text">Searching for a stranger...</div>
        </div>
      </div>`;
    isConnected = false;
    startChattingBtn.style.display = 'none';
    nextBtn.style.display = 'none';
  } else if (text.includes("Connected")) {
    isConnected = true;
    startChattingBtn.style.display = 'none';
    nextBtn.style.display = 'none';
    setTimeout(() => {
      if (messagesDiv.innerHTML.includes("Connected")) messagesDiv.innerHTML = '';
    }, 3000);
  } else {
    isConnected = false;
    startChattingBtn.style.display = 'none';
    nextBtn.style.display = 'block';
  }
  scrollToBottom();
  debouncedAdjustLayout();
}

function connectStranger() {
  console.log("Connecting to stranger...");
  showPopup("🔍 Searching for a stranger...");
  typingIndicator.style.display = "none";
  try {
    ws = new WebSocket(window.TIKTALK_BACKEND.replace("https", "wss") + "/ws");
    console.log("WebSocket connecting to:", window.TIKTALK_BACKEND.replace("https", "wss") + "/ws");
  } catch (error) {
    console.error("WebSocket initialization failed:", error);
    showPopup("❌ Failed to connect to server. Please try again.");
    return;
  }

  ws.onopen = () => {
    console.log("WebSocket connected");
    reconnectAttempts = 0;
  };

  ws.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      console.log("WebSocket message received:", data);
      if (data.type === "system") {
        if (data.text === "waiting") {
          showPopup("🔍 Searching for a stranger...");
        } else if (data.text === "connected") {
          showPopup("✅ Connected! Say Hi 👋");
        } else if (data.text === "disconnected") {
          showPopup("❌ Stranger disconnected");
        }
      } else if (data.type === "message") {
        typingIndicator.style.display = "none";
        addMessage(data.text, "stranger");
      } else if (data.type === "typing") {
        typingIndicator.style.display = "block";
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          typingIndicator.style.display = "none";
        }, 1500);
      }
    } catch (error) {
      console.error("Error parsing WebSocket message:", error);
    }
  };

  ws.onclose = () => {
    console.log("WebSocket closed");
    showPopup("❌ Disconnected from server");
    typingIndicator.style.display = "none";
    isConnected = false;
    startChattingBtn.style.display = 'block';
    nextBtn.style.display = 'block';
    if (reconnectAttempts < maxReconnectAttempts) {
      setTimeout(() => {
        reconnectAttempts++;
        console.log(`Reconnect attempt ${reconnectAttempts} of ${maxReconnectAttempts}`);
        connectStranger();
      }, 2000 * reconnectAttempts);
    } else {
      showPopup("❌ Failed to reconnect. Please try again later.");
    }
    debouncedAdjustLayout();
  };

  ws.onerror = (error) => {
    console.error("WebSocket error:", error);
    ws.close();
  };
}

const handleStartChatting = (e) => {
  console.log("Start Chatting clicked");
  e.preventDefault();
  if (ws) ws.close();
  startChattingBtn.style.display = 'none';
  connectStranger();
};
startChattingBtn.removeEventListener("click", handleStartChatting);
startChattingBtn.removeEventListener("touchstart", handleStartChatting);
startChattingBtn.addEventListener("click", handleStartChatting);
startChattingBtn.addEventListener("touchstart", handleStartChatting, { passive: false });

const handleSend = (e) => {
  console.log("Send button clicked");
  e.preventDefault();
  if (isConnected && input.value.trim()) {
    ws.send(JSON.stringify({type: "message", text: input.value}));
    addMessage(input.value, "me");
    input.value = "";
    emojiPicker.classList.remove('show');
    emojiPicker.style.display = 'none';
    document.getElementById("emojiToggle").textContent = "😊";
    document.getElementById("emojiToggle").setAttribute('aria-expanded', 'false');
    debouncedAdjustLayout();
  }
};
sendBtn.removeEventListener("click", handleSend);
sendBtn.removeEventListener("touchstart", handleSend);
sendBtn.addEventListener("click", handleSend);
sendBtn.addEventListener("touchstart", handleSend, { passive: false });

const handleNext = (e) => {
  console.log("Next button clicked");
  e.preventDefault();
  if (ws) ws.close();
  connectStranger();
  debouncedAdjustLayout();
};
nextBtn.removeEventListener("click", handleNext);
nextBtn.removeEventListener("touchstart", handleNext);
nextBtn.addEventListener("click", handleNext);
nextBtn.addEventListener("touchstart", handleNext, { passive: false });

input.addEventListener("input", () => {
  if (isConnected && ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({type: "typing"}));
  }
});

document.body.classList.add('auto-scroll-enabled');
const observer = new MutationObserver(scrollToBottom);
observer.observe(messagesDiv, { childList: true, subtree: true });
</script>
</body>
</html>